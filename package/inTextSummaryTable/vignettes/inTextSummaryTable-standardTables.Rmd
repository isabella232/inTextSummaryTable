---
title: "Creation of standard in-text tables for with the `inTextSummaryTable` package"
author: "Laure Cougnaud"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_depth: 5
    number_sections: true
    toc_float:
      collapsed: false
    highlight: "pygments"
vignette: >
  %\VignetteIndexEntry{Creation of standard in-text summary tables}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# Introduction

```{r options, echo = FALSE}
	
	library(knitr)
	opts_chunk$set(
		echo = TRUE, results = 'asis', warning = FALSE, 
		error = FALSE, message = FALSE, cache = FALSE,
		fig.width = 8, fig.height = 7,
		fig.path = "./figures_vignette/",
		#out.width = '0.7\\textwidth', 
		fig.align = 'center')#, out.height = 0.5\\textwidth', fig.path = 'graphs/') 
	options(width = 170)#, stringsAsFactors = FALSE
	options(warn = 1)#instead of warn = 0 by default -> to have place where warnings occur in the call to Sweave function
	
```

```{r loadPackages}

	library(inTextSummaryTable)

```

## Data format

A phase 2 example dataset: the _Pelican_ study is used as demonstration.
The function `loadDataADaMSDTM` of the `glpgUtilityFct` package might be used to load the data 
into a similar format into R.

```{r loadData}	
	
	library(glpgUtilityFct)
	library(tools)# toTitleCase

	# load example data
	data(ADaMDataPelican)
	data(labelVarsADaMPelican)
	
	dataAll <- ADaMDataPelican
	labelVars <- labelVarsADaMPelican

```

Typical in-text table for the CSR are included in the following sections, based
on the standard _Statistical Analysis Plan_ and Mock TLFs for phase 2 and 3 (25/07/2019).
Please note that the content or formatting (e.g. number of decimals)
of the table might depends of the study and dataset 
(refer to the specific study _Standard Analysis Plan_), and be subject to change.

# Statistical analyses

## Subject information

### Demographics and Baseline Disease Characteristics

```{r demographicTable}

	# data of interest
	dataDM <- subset(dataAll$ADSL, SAFFL == "Y")
	
	# variables of interest
	# Note: if available: ethnicity is included
	varsDM <- c(
		"SEXC", "AGE", "AGEC",
		"RACE", #"ETHNIC"
		"HEIGHT", "WEIGHTBL", 
		"BMIBL",
		"DIAGDURY", "DIAGDURYC"
	)
	
	# Add missing variables:
	dataDM$AGEC <- cut(dataDM$AGE, 
		breaks = c(-Inf, 18, 65, 85, Inf), 
		labels = c("<18", "[18,65[", "[65,85[", ">=85"),
		right = FALSE
	)
	
	dataDM$DIAGDURYC <- cut(
		dataDM$DIAGDURY, 
		breaks = c(-Inf, 1, 2, 5, 10, 20, Inf), 
		labels = c("<1", "[1, 2[", "[2,5[", "[5,10[", "[10,20[", ">=20"),
		right = FALSE
	)
	# Ethnicity should be available in the ADaM

	# sort variables according to corresponding numeric variable
	dataDM <- convertVarToFactor(
		data = dataDM,
		var = c("BMIBLGR1", "RACE", "SEXC", "TRT01P"),
		varNum = c("BMIBLG1N", "RACEN", "SEXN", "TRT01PN")
	)
	
	## reformat labels:
	
	labelVars["SEXC"] <- "Gender" # use 'Gender' and not 'Sex' label
	labelVars["AGEC"] <- "Age, categorized (years)"
	labelVars["DIAGDURYC"] <- sub(" (years)", ", categorized (years)", labelVars["DIAGDURY"], fixed = TRUE)
	
	stop("test")
	
	# statistics of interest
	statsNum <- getStats("median (range)")
	statsCat <- getStats("n (%)", includeName = FALSE)
	library(plyr)
	varsDMIsNum <- colwise(is.numeric, varsDM)(dataDM)
	statsDM <- sapply(varsDMIsNum, function(isNum) 
		if(isNum)	statsNum	else	statsCat,
		simplify = FALSE)
	
	# create the table
	test <- computeSummaryStatisticsTable(
		data = dataDM, 
		# variables to summarize
		var = varsDM,
		varGeneralLab = "Parameter",
		# column
		colVar = "TRT01P", colTotalInclude = TRUE, colTotalLab = "All subjects",
		# statistics
		stats = statsDM,
		statsGeneralLab = "",
		labelVars = labelVars,
		# if only one category, should be included in separated row (e.g. RACE: White)
		rowAutoMerge = FALSE,
		rowInclude0 = FALSE,
		title = toTitleCase(
			paste("Table: Descriptive Statistics of Demographic Data",
				"and Baseline Characteristics (Safety Analysis Set)"
			)
		),
		file = file.path("tables_CSR", "Table_demographicDataAndBaselineCharacteristics.docx")
	)
	
```

## Laboratory abnormalities

The laboratory parameters are grouped by category, and the visit is indicated in
the rows: `PARCAT1`, `PARCAT2` and `AVISIT` are specified in `rowVar`. The
treatment is reported in the column: `TRTP` specified in `colVar`.

Because the laboratory measurement reported as normal or empty ('') in the ADaM
are not of interest, these classes are filtered via the `varIgnore` parameter.

By default, the number ('N') and percentage ('Perc') are reported for each
`rowVar`/`colVar`.

```{r example-countTable-LB}

	dataLB <- subset(dataAll$ADLB, AN01FL == "Y")
	
	# ensure that order of elements is the one specified in the corresponding numeric variable
	library(glpgUtilityFct)
	dataLB[dataLB[, "PARCAT2"] == "", "PARCAT2"] <- "OTHER"
	dataLB <- convertVarToFactor(
		data = dataLB, 
		var = c("PARCAT1", "PARCAT2", "AVISIT", "TRTP", "ANRIND"), 
		varNum = c("PARCAT1N", "PARCAT2N", "AVISITN", "TRTPN", "ANRINDN")
	)
	
	# only consider abnormalities
	dataLB <- subset(dataLB, !ANRIND %in% c("", "L"))
	
	# specific analysis visits
	dataLB <- subset(dataLB, AVISIT %in% c("Baseline", "Day 14", "Day 28", "Follow-up"))
	
	dataLB$ANRIND <- factor(dataLB$ANRIND, 
		levels = c('L', 'N', 'H', 'H+L'),
		labels = c("Low", "Normal", "High", "High+Low")
	)
	
	# create summary table
	getSummaryStatisticsTable(
		data = dataLB,
		rowVar = c("PARCAT1", "PARCAT2", "PARAM", "ANRIND"),
		rowVarInSepCol = "ANRIND",
		rowVarLab = c(PARAM = "Laboratory Parameter\nn (%)", labelVars["ANRIND"]),
		colVar = c("TRTP", "AVISIT"),  
		type = "count",
		labelVars = labelVars,
		stats = getStats("n (%)"),
		title = "Table: Laboratory abnormalities",
		footer = "Statistics: n (%)",
		landscape = TRUE,
		file = file.path("tables", "Table_LB.docx")
	)

```

## Adverse events

### Treatment-emergent summary table

```{r example-summaryTable-AE}

	# Only consider safety analysis set
	dataAESAS <- subset(dataAll$ADAE, SAFFL == "Y")
	
	# total in safety analysis set
	dataTotalSAS <- subset(dataAll$ADSL, SAFFL == "Y")
	dataTotalSAS$TRTP <- dataTotalSAS$TRT01P
	
	# Sort treatments
	dataAESAS$TRTP <- with(dataAESAS, reorder(TRTP, TRTPN))

	## build flags of interest
	# For each variable, the number of subjects and percentage of subjects flagged will be counted.
	# Flag subjects with '', e.g present but shown as no label
	# excepted for the worst-intensity for which the counts for each category are displayed
	
	# treatment emergent
	dataAESAS$TEAE <- ifelse(dataAESAS$TRTEMFL == "Y", "", "N")
	
	# serious TEAE adverse event
	dataAESAS$TEAESER <- with(dataAESAS, ifelse(TRTEMFL == "Y" & AESER == "Y", "", "N"))
	
	# TEAE leading to death 
	dataAESAS$TEAED <- with(dataAESAS, ifelse(TRTEMFL == "Y" & DTHFL == "Y", "", "N"))
	
	# TEAE with worst intensity

	# build worst-case scenario
	dataAESAS <- ddply(dataAESAS, c("USUBJID", "TRTP"), function(x){
		res <- cbind.data.frame(x, 
			AESEVWC = ifelse(x$AESEVN == max(x$AESEVN), as.character(x$AESEV), ""), 
			stringsAsFactors = FALSE
		)			
	})
	# order levels/add severe class
	dataAESAS$TEAESEVWC <- with(dataAESAS, ifelse(TRTEMFL == "Y" & AESEVWC != "", AESEVWC, ""))
	dataAESAS$TEAESEVWC <- factor(dataAESAS$AESEVWC, levels = c("MILD", "MODERATE", "SEVERE")) 

	# study-drug related TEAE (AERELN == 1 <==> AREL == "Related")
	dataAESAS$TEAEREL <- with(dataAESAS, ifelse(TRTEMFL == "Y" & AREL == "Related", "", "N"))
	
	# study-drug temporarily stopped
	dataAESAS$TEAETS <- with(dataAESAS, ifelse(TRTEMFL == "Y" & AEACN == "TEMPORARILY STOPPED", "", "N"))
	
	# study-drug permanently stopped
	# (Note: in this dataset, specific variable: AEINTFL == Treatment stopped Flag)
	dataAESAS$TEAEPS <- with(dataAESAS, ifelse(TRTEMFL == "Y" & AEACN == "DRUG WITHDRAWN", "", "N"))
	
	## specify labels for each variable:
	varAESummaryLabels <- c(
		TEAE = "TEAE", TEAESER = "Serious TEAE", 
		TEAED = "TEAE leading to death",
		TEAESEVWC = "TEAE with worst severity",
		TEAEREL = "Study drug-related TEAE",
		TEAETS = "Study drug temporarily stopped",
		TEAEPS = "Study drug permanently stopped"
	)
	varAESummary <- names(varAESummaryLabels)
	
	## convert all variables as factor 
	# this also enables  to include rows with empty variable
	dataAESAS[, setdiff(varAESummary, "TEAESEVWC")] <- colwise(factor, levels = c("N", ""))(dataAESAS[, setdiff(varAESummary, "TEAESEVWC")])

	# Data for the total column
	# General approach (applicable for cross-over and parallel design):
	# derive worst-case scenario across treatments
	# (because patient can have different WC per treatment but should be considered once in the total column)
	dataAESASAcrossTreatments <- ddply(dataAESAS, "USUBJID", function(x){
		x$AESEVWC <- ifelse(x$AESEVN == max(x$AESEVN), as.character(x$AESEV), "")
		x
	})
	
	# create the table
	getSummaryStatisticsTable(
		data = dataAESAS,
		colVar = "TRTP",
		# define variables to compute statistics on
		var = varAESummary,
		varLab = varAESummaryLabels,
		varGeneralLab = "Number of subjects with:",
		# statistics:
		stats = unname(getStats('n (%)')),
		# only consider the subjects flagged by the variable:
		filterFct =  function(x){
			subset(x, isTotal | variableGroup != "N")
		},
		# include the total for the worst-case scenario
		varTotalInclude = "TEAESEVWC",
		labelVars = labelVars,
		# include a 'total' column
		colTotalInclude = TRUE,
		dataTotalCol = dataAESASAcrossTreatments, # data used for the total column
		# dataset used for the total in the header column (and for percentage as default)
		dataTotal = dataTotalSAS,
		# title/export
		title = toTitleCase("Table: Summary table of TEAEs (safety analysis set)"),
		file = file.path("tables_CSR", "Table_TEAE_summary.docx")
	)
	
```

### Count table

```{r example-countTable-AE}

	dataAEInterest <-  subset(dataAll$ADAE, FASFL == "Y")
	
	# ensure that order of elements is the one specified in the corresponding numeric variable
	library(glpgUtilityFct)
	dataAEInterest <- convertVarToFactor(
		data = dataAEInterest, 
		var = "TRTP", 
		varNum = "TRTPN"
	)

	# dataset used to extract the 'Total'
	dataTotal <- dataAll$ADSL
	# should contain columns specified in 'colVar'
	dataTotal$TRTP <- dataTotal$TRT01P 
	
	getSummaryStatisticsTable(
		data = dataAEInterest,
		type = "count",
		rowVar = c("AEHLGT", "AEHLT", "AELLT"),
		colVar = "TRTP",
		labelVars = labelVars,
		title = "Table: Adverse Events",
		dataTotal = dataTotal,
		rowVarTotalInclude = "AEHLGT",
		stats = list(expression(paste0(statN, " (", round(statPercN, 1), ")"))),
		footer = "Statistics: n (%)",
		file = "summaryStatisticsTable_AE_count.docx",
	)

```

## Pharmacokinetic parameters

```{r example-PP}

	# format labels with subscript
	paramLabelPK <- c(
		CTROUGH = "C_{trough} (ng/mL)", 
		TLAG = "t_{lag} (h)",
		TMAX = 't_{max} (h)', 
		CMAX = "C_{max} (ng/mL)",
		AUCTAU = "AUC_{0-t} (ng.h/mL)",
		AUC08H = "AUC_{0-8h} (ng.h/mL)"
	)
	dataPP$PARAMRF <- paramLabelPK[dataPP$PARAMCD]
	
	# for each PK parameter: number of decimals if max number dicmals of AVAL based on:
	# 2 decimals for values < 10
	# 1 decimal for values > 10 and < 1000
	# No decimals for value > 1000.
	customNDec <- function(x)	ifelse(x > 1000, 0, ifelse(x > 10, 1, 2))
	nMaxDec <- daply(dataPP, "PARAMRF", function(x) max(customNDec(x$AVAL), na.rm = TRUE))
	
	# Values are arithmetic mean (CV%) except median (min-max) for tmax
	# [mean, median]: + 1 digit
	nMaxDecTMax <- unname(nMaxDec[paramLabelPK["TMAX"]])
	statsPP <- sapply(nMaxDec, function(nMaxDec){
		list(
			bquote(
				ifelse(statMean == 0, 0, paste0(
						roundCustomText(statMean, .(nMaxDec + 1)), " (",
						roundCustomText(statCVPerc, .(nMaxDec)), ")"
					)
				)
			)
		)
	}, simplify = FALSE)
	
	getSummaryStatisticsTable(
		data = subset(dataPP, PARCAT1 %in% c("Ivacaftor", "Lumacaftor")),
		var = "AVAL",
		colVar = "TRTP",
		rowVar = c("PARCAT1", "PARAMRF"),
		rowVarLab = c(
			'PARAMRF' = "Pharmacokinetics parameter\nfor each compound^{(1)}", # use superscript for the foonote
			'PARCAT1' = "" 
		),
		statsExtra = list(statCVPerc = cv),
		stats = statsPP, statsVarBy = "PARAMRF",
		# include the footnote
		footer = c(
			"Mean (CV%) indicated for each parameter.",
			"(1) Each compound is labelled according to its Galapagos compound ID."
		),
		file = file.path("tables", "Table_superscriptSubscriptTitleFootnote.docx"),
		title = "Table: PK Parameters (Safety Analysis Set)"
	)	

```

## Mock-up tables

```{r mockUpTables}

	# create summary table
	getSummaryStatisticsTable(
		data = subset(dataLB, PARCAT2 %in% c("ENZYMES", "LIPIDS")),
		rowVar = c("PARCAT1", "PARCAT2", "PARAM", "ANRIND"),
		rowVarInSepCol = "ANRIND",
		colVar = c("TRTP", "AVISIT"),  
		type = "count",
		labelVars = labelVars,
		rowVarLab = c(PARAM = "Parameter", labelVars["ANRIND"]),
		stats = list(expression(paste0("[X.XX]"))),
		title = "Table: Treatment-emergent laboratory abnormalities (mock-up)",
		footer = "Statistics: n (%)",
		landscape = TRUE,
		file = file.path("tables", "Table_mockUp.docx")
	)

```

# Appendix

## Session information

```{r includeSessionInfo, echo = FALSE}

	pander(sessionInfo())

```
