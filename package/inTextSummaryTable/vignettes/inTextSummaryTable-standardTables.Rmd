---
title: "Creation of standard in-text tables for with the `inTextSummaryTable` package"
author: "Laure Cougnaud"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: glpgStyle::html_report
vignette: >
  %\VignetteIndexEntry{Creation of standard in-text summary tables}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# Introduction

```{r options, echo = FALSE}
	
	library(knitr)
	opts_chunk$set(
		echo = TRUE, results = 'asis', warning = FALSE, 
		error = FALSE, message = FALSE, cache = FALSE,
		fig.width = 8, fig.height = 7,
		fig.path = "./figures_vignette/",
		#out.width = '0.7\\textwidth', 
		fig.align = 'center')#, out.height = 0.5\\textwidth', fig.path = 'graphs/') 
	options(width = 170)#, stringsAsFactors = FALSE
	options(warn = 1)#instead of warn = 0 by default -> to have place where warnings occur in the call to Sweave function
	
```

```{r loadPackages, warning = FALSE}

	library(glpgUtilityFct)
	library(tools)# toTitleCase
	library(plyr) # for ddply
	library(pander) # for session info
	library(inTextSummaryTable)

```

## Data format

A phase 2 example dataset: the _Pelican_ study is used as demonstration.
The function `loadDataADaMSDTM` of the `glpgUtilityFct` package might be used to load the data 
into a similar format into R.

```{r loadData}	

	# load example data
	data(ADaMDataPelican)
	data(labelVarsADaMPelican)
	
	dataAll <- ADaMDataPelican
	labelVars <- labelVarsADaMPelican

```

Typical in-text table for the CSR are included in the following sections, based
on the standard _Statistical Analysis Plan_ and Mock TLFs for phase 2 and 3 (25/07/2019).
Please note that the content or formatting (e.g. number of decimals)
of the table might depends of the study and dataset 
(refer to the specific study _Standard Analysis Plan_), and be subject to change.

# Subject information

## Subject disposition

```{r table-subjectDisposition}
	
	# data of interest
	dataDM <- dataAll$ADSL
	
	varDMFL <- grep("FL$", colnames(dataDM), value = TRUE)
	varDMFLLabel <- sub(" Flag$", "", labelVars[varDMFL])
	
	getSummaryStatisticsTable(
		data = dataDM,
		var = varDMFL, varFlag = varDMFL, varGeneralLab = "Analysis Set, N", 
		varLab = varDMFLLabel,
		stats = getStats("n (%)"),
		colVar = "TRT01P",
		labelVars = labelVars,
		colTotalInclude = TRUE, colTotalLab = "All subjects",
		varInclude0 = TRUE,
		# remove 'Screen Failure' column
		filterFct = function(x)
			subset(x, isTotal | !grepl("Screen Failure", TRT01P)),
		title = toTitleCase("Table: subject disposition (full analysis set)"),
		file = file.path("tables_CSR", "Table_subjectDisposition.docx")
	)

```

## Demographics and Baseline Disease Characteristics

```{r table-demography}

	# data of interest
	dataDM <- subset(dataAll$ADSL, FASFL == "Y")
	
	# variables of interest
	# Note: if available: ethnicity is included
	varsDM <- c(
		"SEXC", "AGE", "AGEC",
		"RACE", #"ETHNIC"
		"HEIGHT", "WEIGHTBL", 
		"BMIBL",
		"DIAGDURY", "DIAGDURYC"
	)
	
	# Add missing variables:
	# Note: add droplevels to filter categories not occuring in the data
	dataDM$AGEC <- droplevels(cut(dataDM$AGE, 
		breaks = c(-Inf, 18, 65, 85, Inf), 
		labels = c("<18", "[18,65[", "[65,85[", ">=85"),
		right = FALSE
	))
	dataDM$DIAGDURYC <- droplevels(cut(
		dataDM$DIAGDURY, 
		breaks = c(-Inf, 1, 2, 5, 10, 20, Inf), 
		labels = c("<1", "[1, 2[", "[2,5[", "[5,10[", "[10,20[", ">=20"),
		right = FALSE
	))
	# Ethnicity should be available in the ADaM

	# Sort variables according to corresponding numeric variable
	dataDM <- convertVarToFactor(
		data = dataDM,
		var = c("BMIBLGR1", "RACE", "SEXC", "TRT01P"),
		varNum = c("BMIBLG1N", "RACEN", "SEXN", "TRT01PN")
	)
	
	## Reformat labels:
	labelVars["SEXC"] <- "Gender" # use 'Gender' and not 'Sex' label
	labelVars["AGEC"] <- "Age, categorized (years)"
	labelVars["DIAGDURYC"] <- sub(" (years)", ", categorized (years)", labelVars["DIAGDURY"], fixed = TRUE)
	dataDM$RACE <- factor(dataDM$RACE, 
		levels = levels(dataDM$RACE), 
		labels = simpleCap(tolower(levels(dataDM$RACE)))
	) # lower-case (if not already in ADaM)
	
	## Define set of statistics of interest:
	# 'Median (range)' for continuous variable
	# number of subjects and percentage for categorical variable
	statsDM <- sapply(varsDM, function(var)
		if(is.numeric(dataDM[[var]])){
			getStats(type = "median (range)", x = dataDM[[var]])
		}else{
			getStats(type = "n (%)", includeName = FALSE)
		}
	, simplify = FALSE)

	## create the table:
	
	getSummaryStatisticsTable(
		data = dataDM, 
		# variables to summarize
		var = varsDM,
		varGeneralLab = "Parameter",
		# column
		colVar = "TRT01P", colTotalInclude = TRUE, colTotalLab = "All subjects",
		# statistics
		stats = statsDM,
		statsGeneralLab = "",
		labelVars = labelVars,
		# if only one category, should be included in separated row (e.g. RACE: White)
		rowAutoMerge = FALSE,
		rowInclude0 = FALSE,
		title = toTitleCase(
			paste("Table: Descriptive Statistics of Demographic Data",
				"and Baseline Characteristics (Full Analysis Set)"
			)
		),
		file = file.path("tables_CSR", "Table_demographicDataAndBaselineCharacteristics.docx")
	)
	
```

# Safety Analyses

## Adverse Events

### Treatment-emergent summary table

```{r table-summaryTable}

	# consider only safety analysis set AND TREATMENT-EMERGENT!
	dataTEAE <- subset(dataAll$ADAE, SAFFL == "Y" & TRTEMFL == "Y")
	
	# order treatment and severity categories
	dataTEAE <- convertVarToFactor(
		data = dataTEAE,
		var = c("TRTA", "AESEV"),
		varNum = c("TRTAN", "AESEVN")
	)
	
	# data considered for the total
	dataTotalAE <- subset(dataAll$ADSL, SAFFL == "Y")
	dataTotalAE <- convertVarToFactor(dataTotalAE, var = "TRT01A", varNum = "TRT01AN")
	colnames(dataTotalAE)[colnames(dataTotalAE) == "TRT01A"] <- "TRTA"

	## build flags of interest (if not already available)

	# treatment emergent: 'TRTEMFL'
	
	# serious TEAE adverse event
	dataTEAE$TEAESER <- with(dataTEAE, ifelse(AESER == "Y", "Y", "N"))
	
	# TEAE leading to death 
	dataTEAE$TEAED <- with(dataTEAE, ifelse(TRTEMFL == "Y" & AESDTH == "Y", "Y", "N"))
	
	# TEAE with worst intensity

	# build worst-case scenario
	dataTEAE <- ddply(dataTEAE, c("USUBJID", "TRTA"), function(x){
		maxAESEVN <- max(subset(dataTEAE, TRTEMFL == "Y")$AESEVN)
		cbind.data.frame(x, 
			WORSTINT = with(x, 
				ifelse(TRTEMFL == "Y" & AESEVN == maxAESEVN, as.character(AESEV), NA_character_))
		)
	})

	# study-drug related TEAE
	dataTEAE$TEAEREL <- with(dataTEAE, ifelse(TRTEMFL == "Y" & AREL == "Related", "Y", "N"))
	
	# study-drug temporarily stopped
	dataTEAE$TEAETS <- with(dataTEAE, ifelse(TRTEMFL == "Y" & AEACN == "TEMPORARILY STOPPED", "Y", "N"))
	
	# study-drug permanently stopped
	# (Note: in this dataset, specific variable: AEINTFL == Treatment stopped Flag)
	dataTEAE$TEAEPS <- with(dataTEAE, ifelse(TRTEMFL == "Y" & AEACN == "DRUG WITHDRAWN", "Y", "N"))
	
	## specify labels for each variable:
	varAESummaryLabels <- c(
		TRTEMFL = "TEAE", AESER = "Serious TEAE", 
		TEAED = "TEAE leading to death",
		WORSTINT = "TEAE with worst severity:",
		TEAEREL = "Study drug-related TEAE",
		TEAETS = "Study drug temporarily stopped",
		TEAEPS = "Study drug permanently stopped"
	)
	varAESummary <- names(varAESummaryLabels)
	varAESummaryFlag <- setdiff(varAESummary, "WORSTINT")
	
	# create the table
	getSummaryStatisticsTable(
		data = dataTEAE,
		colVar = "TRTA",
		# define variables to compute statistics on
		varFlag = varAESummaryFlag,
		var = varAESummary,
		varLab = varAESummaryLabels,
		varGeneralLab = "Subjects with, n(%):",
		# force the inclusion of lines for variable without count:
		varInclude0 = TRUE,
		# include the total for the worst-case scenario
		varTotalInclude = "WORSTINT",
		# statistics:
		stats = getStats('n (%)'),
		labelVars = labelVars,
		# dataset used for the total in the header column (and for percentage as default)
		dataTotal = dataTotalAE,
		# title/export
		title = toTitleCase("Table: Summary table of TEAEs (safety analysis set)"),
		file = file.path("tables_CSR", "Table_TEAE_summary.docx")
	)
	
```


#### Events occuring in at least one subject

```{r table-TEAE}

	dataTEAE <- subset(dataAll$ADAE, SAFFL == "Y" & TRTEMFL == "Y")
	
	dataTEAE <- convertVarToFactor(
		data = dataTEAE,
		var = c("TRTA"),
		varNum = c("TRTAN")
	)

	dataTotalAE <- subset(dataAll$ADSL, SAFFL == "Y")
	dataTotalAE <- convertVarToFactor(dataTotalAE, var = "TRT01A", varNum = "TRT01AN")
	colnames(dataTotalAE)[colnames(dataTotalAE) == "TRT01A"] <- "TRTA"
	
	getSummaryStatisticsTable(
		data = dataTEAE,
		rowVar = c("AESOC", "AEDECOD"),
		colVar = "TRTA",
		## total
		# data
		dataTotal = dataTotalAE,
		# row total
		rowVarTotalInclude = c("AESOC", "AEDECOD"), rowTotalLab = "Any TEAE",
		stats = getStats("n (%)"),
		labelVars = labelVars,
		rowVarLab = c('AESOC' = "TEAE by SOC and Preferred Term,\nn (%)"),
		# sort rows based on the total column:
		rowOrder = "total", 
		rowOrderTotalFilterFct = function(x) subset(x, TRTA == "Total"),
		title = paste("Table: Treatment-emergent Adverse Events by System Organ Class",
			"and Preferred Term (Safety Analysis Set)"
		),
		file = file.path("tables_CSR", "Table_TEAE_SOCPT_atLeast1Subject.docx")
	)

```

#### Events occuring in at least 25% of the subjects

```{r table-TEAE-inAtLease25Percent}

	getSummaryStatisticsTable(
		data = dataTEAE,
		rowVar = c("AESOC", "AEDECOD"),
		colVar = "TRTA",
		## total
		# data
		dataTotal = dataTotalAE, 
		# row total
		rowVarTotalInclude = c("AESOC", "AEDECOD"), rowTotalLab = "Any TEAE",
		stats = getStats("n (%)"),
		labelVars = labelVars,
		rowVarLab = c('AESOC' = "SOC and Preferred Term,\nn (%)"),
		# sort rows based on the total column:
		rowOrder = "total", 
		rowOrderTotalFilterFct = function(x) subset(x, TRTA == "Total"),
		title = paste("Table: Treatment-emergent Adverse Events by System Organ Class",
			"and Preferred Term reported in at least 25% of the subjects in any treatment group (Safety Analysis Set)"
		),
		file = file.path("tables_CSR", "Table_TEAE_SOCPT_atLeast25PercentsSubject.docx"),
		# include only events occuring in at least 25% for at least one preferred term:
		filterFct = function(x)
			ddply(x, "AESOC", function(x){ # per AESOC to include the total
				ddply(x, "AEDECOD", function(y)
					if(any(y$statPercN >= 25))	y
				)
			})
	)

```

### Severity

```{r tableTEAE-worstCase}

	dataTEAE <- subset(dataAll$ADAE, SAFFL == "Y" & TRTEMFL == "Y")

	# order treatment and severity based on corresponding numeric variables
	dataTEAE <- convertVarToFactor(
		data = dataTEAE,
		var = c("TRTA", "AESEV"), varNum = c("TRTAN", "AESEVN")
	)
	
	# extract worst-case scenario data (only one record if multiple with same severity)
	dataAEWC <- ddply(dataTEAE, c("AEDECOD", "USUBJID", "TRTA"), function(x){
		x[seq_len(nrow(x)) == which.max(x$AESEV), ]
	})
	dataAEWC$WORSTINT <- dataAEWC$AESEV
	labelVars["WORSTINT"] <- "Worst-case scenario"

	## datasets used for the total: 
	# for total: compute worst-case across SOC and across AE term
	# (otherwise patient counted in multiple categories if present different categories for different AEs)
	dataTotalRow <- list(
		# within SOC (across AEDECOD)
		'AEDECOD' = ddply(dataAEWC, c("AESOC", "USUBJID", "TRTA"), function(x){	
			x[seq_len(nrow(x)) == which.max(x$WORSTINT), ]
		}),
		# across SOC
		'AESOC' = ddply(dataAEWC, c("USUBJID", "TRTA"), function(x){	
			x[seq_len(nrow(x)) == which.max(x$WORSTINT), ]
		})
	)
	
	getSummaryStatisticsTable(
		data = dataAEWC,
		## row variables:
		rowVar = c("AESOC", "AEDECOD", "WORSTINT"), rowVarInSepCol = "WORSTINT",
		# include total across SOC and across AEDECOD
		rowVarTotalInclude = c("AESOC", "AEDECOD"), dataTotalRow = dataTotalRow, 
		rowVarTotalByVar = "WORSTINT", # count for each severity category for the total
		rowTotalLab = "Any TEAE", rowVarLab = c(AESOC = "Subjects with, n(%):", WORSTINT = "Worst-case scenario"),
		# sort per total in the total column
		rowOrder = "total", 
		## column variables
		colVar = "TRTA", 
		stats = getStats("n (%)"),
		emptyValue = "0",
		labelVars = labelVars,
		dataTotal = dataTotalAE,
		title = toTitleCase(paste("Table: Treatment-emergent Adverse Events by system organ",
			"and preferred term by worst-case (Full Analysis Set)"
		)),
		file = file.path("tables_CSR", "Table_TEAE_Severity.docx")
	)
	
```

## Laboratory safety

### Table of laboratory abnormalities

```{r tableLab}

	# The analysis of abnormalities will focus on assessments reported during the treatment period.
	dataLB <- subset(dataAll$ADLB, FASFL == "Y")
	# (in this dataset, worst-case also flagged with 'DTYPE' == "WOC")
	
	dataLBWCWithAbn <- subset(dataLB, AVISIT == "Worst-case post-baseline" & SHIFT1 != "")

	# Total based on available post-dose records
	dataLBPostBaseline <- subset(dataLB, !AVISIT %in% c("Screening", "Worst-case post-baseline", "Baseline"))
	
	# order treatments and lab parameters
	
	# convert factors
	dataLBWCWithAbn <- convertVarToFactor(
		data = dataLBWCWithAbn,
		var = c("PARCAT1", "PARAM", "TRTA", "SHIFT1"),
		varNum = c("PARCAT1N", "PARAMN", "TRTAN", "SHIFT1N")
	)

	# shift table or QC versus baseline
	getSummaryStatisticsTable(
		data = dataLBWCWithAbn,
		rowVar = c("PARCAT1", "PARAM"), 
		colVar = "TRTA",
		var = "SHIFT1", rowVarInSepCol = "variableGroup", varSubgroupLab = "Shift of Worst Case Abnormality",
		rowVarLab = c('PARCAT1' = "Laboratory Parameter\nn (%)"),
		stats = getStats("n (%)"),
		labelVars = labelVars,
		# TO ASK: should the rows be ordered based on the total also for the worst-case column?
		rowOrder = "total",
		dataTotal = dataLBPostBaseline, rowVarTotalPerc = "PARAM",
		title = toTitleCase(paste("Table: Treatment-emergent",
			"Worst-case Laboratory Abnormalities (full analysis set))"
		)),
		emptyValue = "0",
		file = file.path("tables_CSR", "Table_Lab_Severity.docx")
	)

```

## Electrocardiogram

```{r ECG-formatData}

	# data of interest
	paramsECG <- c("QT", "QTCF", "QRS", "PR", "RR", "EGHR")

	dataECG <- subset(dataAll$ADEG, FASFL == "Y" & PARAMCD %in% paramsECG)
	dataECG <- convertVarToFactor(dataECG, var = c("TRTA", "PARAM"), varNum = c("TRTAN", "PARAMN"))
	
	# consider all non-missing post-baseline records
	dataECGPostBaseline <- subset(dataECG, AVISIT %in% c("Screening", "Baseline", "Worst-case post-baseline"))
	
	# worst-case scenario:
	dataECGWC <- subset(dataECG, AVISIT == "Worst-case post-baseline")
	dataECGWC <- convertVarToFactor(dataECGWC, 
		var = c("AVALCAT1", "CHGCAT1"), 
		varNum = c("AVALCA1N", "CHGCAT1N")
	)
	
	# treatment-emergent (a flag should be included in the data)
	# if absnormality is worse compared to baseline
	dataECGWC$TRTEMFL <- with(dataECGWC, ifelse(AVALCAT1 == "" | AVALCA1N > BASECA1N, "Y", "N"))
	
	# create the table
	getSummaryStatisticsTable(
		data = dataECGWC,
		colVar = "TRTA",
		rowVar = "PARAM", rowVarLab = c('PARAM' = "ECG Parameter"),
		var = c("AVALCAT1", "CHGCAT1"),
		rowVarInSepCol = c("variable", "variableGroup"),
		varGeneralLab = "Abnormality",
		varSubgroupLab = "Worst-Case Post-Baseline",
		stats = getStats("n (%)"),
		labelVars = labelVars,
		# total: all post-baseline
		dataTotal = dataECGPostBaseline, 
		emptyValue = "0",
		rowVarTotalPerc = "PARAM", # total per parameter
		# ensure that categories are below the type of abnormality
		rowAutoMerge = FALSE,
		title = toTitleCase(paste("Table: Treatment-emergent worst-case",
			"ECG abnormalities and change from baseline ECH abnormalities (full analysis set)"
		)),
		file = file.path("tables_CSR", "Table_ECG.docx")
	)
	
```

## Vital signs

### Treatment-emergent vital signs abnormalities

```{r tableVitalSigns}

	# analyis set and parameters of interest
	paramVS <- c("HR", "DIABP", "SYSBP", "TEMP")
	dataVS <- subset(dataAll$ADVS, FASFL == "Y" & PARAMCD %in% paramVS)
	
	dataVS <- convertVarToFactor(
		data = dataVS,
		var = c("PARAM", "ANRIND", "TRTA", "SHIFT1"),
		varNum = c("PARAMN", "ANRINDN", "TRTAN", "SHIFT1N")
	)
	
	dataVSWCWithAbn <- subset(dataVS, AVISIT == "Worst-case post-baseline" & SHIFT1 != "")
	dataVSWCWithAbn$SHIFT1 <- droplevels(dataVSWCWithAbn$SHIFT1)
	
	dataVSPostBaseline <- subset(dataVS,AVISIT != "Worst-case post-baseline")
		
	getSummaryStatisticsTable(
		data = dataVSWCWithAbn,
		rowVar = "PARAM", rowVarLab = c(PARAM = "Vital Signs Parameter, n(%)"),
		colVar = "TRTA", 
		var = "SHIFT1", rowVarInSepCol = "variableGroup", varSubgroupLab = "Worst Case Post-Baseline",
#		varInclude0 = TRUE,
		stats = getStats("n (%)"),
		dataTotal = dataVSPostBaseline, colVarTotalPerc = c("TRTA", "PARAM"),
		labelVars = labelVars,
		title = toTitleCase(paste("Table: Treatment-emergent Worst-case",
			"Vital Sign Abnormalities (Safety Analysis Set)"
		)),
		file = file.path("tables_CSR", "Table_VitalSigns_Severity.docx")
	)

```

# Pharmacokinetics analysis

```{r PK}

	dataPK <- subset(dataAll$ADPP, PKFL == "Y")
	
	dataPK <- convertVarToFactor(data = dataPK, 
		var = c("TRTA", "PARAMCD", "PARCAT1"), 
		varNum = c("TRTAN", "PARAMN", "PARCAT1N")
	)
	
	# build labels
	labelsPK <- c(
		AUC08H = "AUC_{0-8h} (ng*h/mL)",
		AUCTAU = "AUC_{0-t} (ng*h/mL)",
		CMAX = "C_{max} (ng/mL)",
		CTROUGH = "Ctrough (ng/mL)",
		TLAG = "t_{lag} (h)",
		TMAX = "t_{max} (h)"
	)
	dataPK$PARAM <- factor(dataPK$PARAMCD, 
		levels = levels(dataPK$PARAMCD), 
		labels = labelsPK[levels(dataPK$PARAMCD)]
	)
	
	# build statistics of interest
	statsPK <- dlply(dataPK, "PARAM", function(dataParam)
		# median (min-max) for tmax:
		if(all(dataParam$PARAMCD == "TMAX")){
			getStats("median\n(range)", x = dataParam$AVAL, includeName = FALSE)
		# mean (CV %) for others
		}else{
			nDecBase <- getMaxNDecimals(dataParam$AVAL)
			list(bquote(paste0(
				roundCustomText(statMean, .(nDecBase + 1)), 
				" (", roundCustomText(statCV, .(nDecBase + 1)), ")"
			)))
		}
	)
	
	getSummaryStatisticsTable(
		data = dataPK,
		rowVar = c("PARCAT1", "PARAM"), colVar = "TRTA",
		var = "AVAL",
		rowVarLab = c('PARCAT1' = "PK parameters"),
		statsExtra = list(statCV = cv), stats = statsPK, statsVarBy = "PARAM",
		emptyValue = "-",
		title = toTitleCase("Table: Summary of PK parameters (pharmacokinetics analysis set)"),
		file = file.path("tables_CSR", "Table_PK_Parameters.docx"),
		footer = "Values are arithmetic means (CV%) except median (min-max) for tmax."
	)

```

# Appendix

## Session information

```{r includeSessionInfo, echo = FALSE}

	pander(sessionInfo())

```
