---
title: "Vignette of the `inTextSummaryTable` package"
author: "Laure Cougnaud"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_depth: 5
    number_sections: true
    toc_float:
      collapsed: false
    highlight: "pygments"
vignette: >
  %\VignetteIndexEntry{inTextSummaryTable package}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# Introduction

```{r options, echo = FALSE}
	
	library(knitr)
	opts_chunk$set(
		echo = TRUE, results = 'asis', warning = FALSE, 
		error = FALSE, message = FALSE, cache = FALSE,
		fig.width = 8, fig.height = 7,
		fig.path = "./figures_vignette/",
		#out.width = '0.7\\textwidth', 
		fig.align = 'center')#, out.height = 0.5\\textwidth', fig.path = 'graphs/') 
	options(width = 170)#, stringsAsFactors = FALSE
	options(warn = 1)#instead of warn = 0 by default -> to have place where warnings occur in the call to Sweave function
	
```

The package `inTextSummaryTable` contains functionalities to **create
complex table of summary statistics or counts of metrics of interest**, to
**format them as in-text table**.
These tables can be included into a `rmarkdown` document, to be
converted into `html`/`docx` and `pptx`.
Each table can be exported into a `docx` document.

```{r loadPackages}

	library(pander)
	library(inTextSummaryTable)

```

## Data format

The input data for the creation of summary table should be a **data.frame**,
usually loaded from _SAS_ data file (`sas7bdat` format).
The label of the variables stored in the `SAS` datasets is also used
for the title/captions. 

Example datasets from the _Pelican_ study included in the
`glpgpUtilityFct` package are used for demonstration in the
vignette.  

Note that the `loadDataADaMSDTM` function of the `glpgUtilityFct` package can
be used to your custom `SAS` dataset(s) of interest.

```{r loadData}	
	
	library(glpgUtilityFct)

	# load example data
	data(ADaMDataPelican)
	data(labelVarsADaMPelican)
	
	dataAll <- ADaMDataPelican
	labelVars <- labelVarsADaMPelican

```

# Summary table

The main workhorse function is: **`getSummaryStatisticsTable`** which creates an
in-text table of summary statistics for variable(s) of interest.

## General type: summary statistics and/count table

Two types of table can be created: a count or summary table.

By default, the type of the table is **automatically detected** based on the
variable type. This can also be specified via the `type` parameter set to:
`summaryTable`, `countTable` or `auto` (by default, mixed type).

Note: all functionalities described below for the summary statistics table are
also available for the count table (and vice versa).

The _Demographic_ data (`ADPD` dataset) is used as example for the summary
statistics table.

```{r data-SL}

	dataSL <- dataAll$ADSL

```

### Count table

A **count table for discrete variable** (integer, factor, character) indicates
the counts of the number of subjects or records per category of interest (if
\code{var} is specified)



#### Simple count table

If **no variable is specified** (`var` parameter), the number of
subjects/records are counted in the **entire dataset**.

```{r count-simple}

	getSummaryStatisticsTable(data = dataSL)

```

#### Count table of categories

If a **variable is specified** via the `var` parameter, the **counts of each
sub-category/class** of the specified variable are extracted.

```{r count-categories}

	getSummaryStatisticsTable(data = dataSL, var = "SEX")

```

#### Empty rows/columns

```{r data-AE}

	dataAE <-  subset(dataAll$ADAE, FASFL == "Y" & TRTEMFL == "Y")
	dataAEInterest <- subset(dataAE, AESOC %in% c("Infections and infestations", "General disorders and administration site conditions", "Ear and labyrinth disorders"))

```

The parameters **`rowInclude0` and `colInclude0`** are set to TRUE to **include
statistics for empty categories**. These categories are specified via additional
**levels in a factor variable**.

```{r countTable-LBWhiteBlood-emptyVars}

	## only consider White blood cell adverse events
	dataAEWBCA <- subset(dataAE, AEHLT == "White blood cell analyses")
	
	## create dummy categories for:
	# treatment
	dataAEWBCA$TRTP <- with(dataAEWBCA, 
		factor(TRTP, levels = c(unique(as.character(TRTP)), "Treatment B"))
	)
	# low-level term category
	dataAEWBCA$AELLT <- with(dataAEWBCA, 
		factor(AELLT, levels = c(unique(as.character(AELLT)), "Lymphocyte percentage increased"))
	)
	
	# create summary statistics table
	getSummaryStatisticsTable(
		data = dataAEWBCA,
		type = "count",
		rowVar = "AELLT",
		rowInclude0 = FALSE, colInclude0 = TRUE,
		colVar = "TRTP",
		labelVars = labelVars,
		title = "Table: Adverse Events: white blood cell analyses",
		stats = getStats("n (%)"),
		footer = "Statistics: n (%)"
	)

```

### Summary statistics table

**A summary statistics table** indicates **standard distribution statistics
  (mean, median, minimum, maximum, standard error, standard deviation, and count
  statistics) of a numeric variable**.

If `var` parameter is set to a numeric variable of interest, its summary
statistics are displayed.

```{r numeric}

	getSummaryStatisticsTable(data = dataSL, var = "AGE")

```

### Mixed table

If multiple variables are specified, their statistics are indicated in the
horizontal direction.
Discrete and numeric variable can be combined.

```{r mixedTable}

	getSummaryStatisticsTable(
		data = dataSL, 
		var = c("AGE", "HEIGHT", "WEIGHTBL", "BMIBL", "RACE", "SEX")
	)

```

## Statistics

### Custom statistics format

#### For the entire table

The set of summary statistics can be combined and the format can be customized
via the `stats` parameter. This parameter is an list `expression` of the
statistics computed by default (`stat[X]` variable(s)).

If an unique statistic expression is specified, the 'Statistic' column doesn't
appear in the table. In case multiple statistics are specified, these are
included as separated row.

For example, the following count table is restricted to the number of subjects
per categories:

```{r stats-N}

	getSummaryStatisticsTable(
		data = dataSL,
		var = c("RACE", "SEX"),
		stats = list(N = expression(statN))
	)

```

The summary statistics table is restricted to the median and
range:

```{r stats-meanSE}

	getSummaryStatisticsTable(
		data = dataSL,
		var = c("AGE", "HEIGHT", "WEIGHTBL", "BMIBL"),
		varGeneralLab = "Parameter", statsGeneralLab = "",
		colVar = "ACTARM",
		stats = list(
			`median` = expression(statMedian),
			`(min, max)` = expression(paste0("(", statMin, ",", statMax, ")"))
		),
		file = file.path("tables", "Table_statsLayout_rowInSepCol.docx"),
		statsLayout = "rowInSepCol"
	)

```

A few sets of recurrent statistic formats (for the `stats` parameter) are
available in the `getStats` function: summary statistics, count table, ...

```{r getStats}

	## count table:

	# count: N, '%' and m
	getSummaryStatisticsTable(
		data = dataSL,
		var = "SEX",
		stats = getStats("count")
	)

	# N(%)
	getSummaryStatisticsTable(
		data = dataSL,
		var = "SEX",
		stats = getStats("n (%)")
	)
	
	# all summary stats
	getSummaryStatisticsTable(
		data = dataSL,
		var = "AGE",
		stats = getStats("summary")
	)

```

#### By statistical variable or group

The statistics can also be provided for each statistical variable separately:

```{r statExtra-EachVariable}
		
	getSummaryStatisticsTable(
		data = dataSL, 
		var = c("AGE", "RACE"),
		stats = list(
			AGE = getStats("median (range)"),
			RACE = getStats("n (%)")
		)
	)

```

### Extra statistics

A set of extra statistics functions,not available in the default statistics, can
be specified via the `statsExtra` (named list of functions).
These statistics are then available for customization via the `stats` parameter.

For example, the Coefficient of Variation (as a percentage) is computed for the
height.

```{r statsExtra}

	# include the coefficient of variable
	getSummaryStatisticsTable(
		data = dataSL,
		var = "HEIGHT",
		statsExtra = list(statCVPerc = function(x) sd(x)/mean(x)*100)
	)
	
	# only display 
	getSummaryStatisticsTable(
		data = dataSL,
		var = "HEIGHT",
		statsExtra = list(statCVPerc = function(x) sd(x)/mean(x)*100),
		stats = list(Mean = expression(statMean), 'CV%' = expression(statCVPerc))
	)

```

### Statistics layout

The layout of the statistics is specified via the `statsLayout` parameter.  

By
default, the statistics are included in rows, after each element of the row
variable(s).

```{r statsLayoutRow}

	# statsLayout = 'row'
	getSummaryStatisticsTable(
		data = dataSL,
		var = c("AGE", "HEIGHT"),
		stats = list(Mean = expression(statMean), 'SE' = expression(statSE))
	)
	
```

The statistics can also be included in columns.

```{r statsLayoutCol}

	getSummaryStatisticsTable(
		data = dataSL,
		var = c("AGE", "HEIGHT"),
		stats = list(Mean = expression(statMean), 'SE' = expression(statSE)),
		statsLayout = "col"
	)

```

The statistics can also be specified in rows, but in separated column.

```{r summaryTable-PP-medianMinMax-statsLayoutRowVarInSepCol}

	getSummaryStatisticsTable(
		data = dataSL,
		var = c("AGE", "HEIGHT"),
		stats = list(Mean = expression(statMean), 'SE' = expression(statSE)),
		statsLayout = "rowInSepCol"
	)

```


### Rounding

To specify fixed amounts of digits for the statistics 
to be displayed in the table, the statistics can be formatted in the `stats`
parameter.

For example, the AGE is displayed with 1 digit and the height with two digits:

```{r stats-digits}

	getSummaryStatisticsTable(
		data = dataSL,
		var = c("AGE", "HEIGHT"),
		stats = list(
			AGE = list(Median = expression(roundCustomText(statMedian, 1))),
			HEIGHT = list(Median = expression(roundCustomText(statMedian, 2)))
		)
	)

```

Note: by default the `round` function in R rounds the number to the even number
in case of 0.5. The `roundCustomText` function rounds to the closest digits.

Note: a custom function can be created to create custom statistics with
fixed number of digits:

```{r stats-digits-complex}

	# wrapper function to include median with specific number of digits
	# and min/max with specified number of digits - 1
	statsDMNum <- function(digitsMin)
		list('Median (range)' = 
			bquote(paste0(roundCustomText(statMedian, .(digitsMin+1)), 
				" (", roundCustomText(statMin, .(digitsMin)), ",", roundCustomText(statMax, .(digitsMin)),
				")")	
		)
	)

	getSummaryStatisticsTable(
		data = dataSL,
		var = c("AGE", "HEIGHT", "WEIGHTBL", "BMIBL", "RACE", "SEX"),
		stats = list(
			AGE = statsDMNum(0),
			HEIGHT = statsDMNum(1),
			WEIGHTBL = statsDMNum(1),
			BMIBL = statsDMNum(1),
			RACE = getStats("n (%)"),
			SEX = getStats("n (%)")
		)
	)

```

## Table layout

Grouping variable can be specified in the vertical direction (across rows) or
in the horizontal direction (across columns).

The adverse events dataset is used for demonstration.

```{r countTable-AE-data}
				
	# ensure that order of elements is the one specified in the corresponding numeric variable
	library(glpgUtilityFct)
	dataAEInterest <- convertVarToFactor(
		data = dataAEInterest, 
		var = c("TRTP", "AESEV"),
		varNum = c("TRTPN", "AESEVN")
	)

```

### Row and column variables

Specific grouping variable(s) for the columns can be specified via the
**`colVar`** parameter and for the rows via the **`rowVar`** parameter.

If multiple category variables are specified, they should be specified in
hierarchical order.

```{r rowVarColVar}

	# unique row variable
	getSummaryStatisticsTable(
		data = dataAEInterest,
		rowVar = "AEDECOD",
		stats = getStats("n (%)"),
		labelVars = labelVars,
		file = file.path("tables", "Table_AE_1rowVar.docx")
	)
	
	# multiple nested row variables
	getSummaryStatisticsTable(
		data = dataAEInterest,
		rowVar = c("AESOC", "AEDECOD"),
		stats = getStats("n (%)"),
		labelVars = labelVars,
		file = file.path("tables", "Table_AE_2rowVar.docx")
	)
	
	# unique column variable
	getSummaryStatisticsTable(
		data = dataAEInterest,
		colVar = "TRTP",
		stats = getStats("n (%)"),
		labelVars = labelVars
	)
	
	# combination of rows and columns
	getSummaryStatisticsTable(
		data = dataAEInterest,
		rowVar = c("AESOC", "AEDECOD"),
		colVar = "TRTP",
		stats = getStats("n (%)"),
		labelVars = labelVars,
		colHeaderTotalInclude = FALSE,
		file = file.path("tables", "Table_AE_rowColVar.docx")
	)

```

### Row variable

By default, if multiple row variables are specified, they are considered nested
and displayed in the first column of the final table.
Each sub-category is indicated with a specific indent (customizable with
`rowVarPadBase`).

#### Variable in separated column

**Row variables** that shouldn't be included in the unique column with the row
variables, but as **separated column** are additionally specified via the
`rowVarInSepCol` parameter.

```{r rowVarInSepCol}

	getSummaryStatisticsTable(
		data = dataAEInterest,
		rowVar = c("AESOC", "AEDECOD", "AESEV"),
		rowVarInSepCol = "AESEV",
		colVar = "TRTP",
		stats = getStats("n (%)"),
		labelVars = labelVars,
		file = file.path("tables", "Table_exampleRowVarInSepCol.docx")
	)
	
```

#### Row ordering

The **categories in the row variables can be ordered** based on the
**`rowOrder`** variable. 

This variable is either:

* a string with the name of an implemented method to order the rows, among:
     + `alphabetical`: categories are ordered **alphabetically**
     + `auto`: order of the categories in the **input variable** (factor levels) 
are retained (ordered alphabetically if not specified), e.g. to use the ordering
       based on the corresponding numeric variable  in the dataset ('AEHLGTCD'
       for 'AEHLGT')
     + `total`: categories are ordered based on the **total of the
       sub-category**
* a custom ordering function to apply in the data to order the rows

##### Common order for all row variables

```{r rowOrder-common}

	# 'auto'
	getSummaryStatisticsTable(
		data = dataAEInterest,
		rowVar = c("AESOC", "AEDECOD"),
		rowVarLab = labelVars[c("AEDECOD")],
		rowVarTotalInclude = c("AESOC", "AEDECOD"),
		colVar = "TRTP", colTotalInclude = TRUE,
		stats = getStats("n (%)"),
		labelVars = labelVars,
		file = file.path("tables", "Table_rowOrder_alphabetical.docx")
	)
	
	# total counts
	getSummaryStatisticsTable(
		data = dataAEInterest,
		rowVar = c("AESOC", "AEDECOD"),
		rowVarLab = labelVars[c("AEDECOD")],
		rowVarTotalInclude = c("AESOC", "AEDECOD"),
		colVar = "TRTP", colTotalInclude = TRUE,
		rowOrder = "total",
		stats = getStats("n (%)"),
		labelVars = labelVars,
		file = file.path("tables", "Table_rowOrder_total.docx")
	)

```

##### Different orders for each row variable

In case the order should be different for each row variable, a named list is
provided for the `rowVar` parameter.

```{r rowOrder-specific}

	getSummaryStatisticsTable(
		data = dataAEInterest,
		rowVar = c("AESOC", "AEDECOD"),
		rowVarLab = labelVars[c("AEDECOD")],
		rowVarTotalInclude = c("AESOC", "AEDECOD"),
		colVar = "TRTP", colTotalInclude = TRUE,
		rowOrder = c(AESOC = "alphabetical", AEDECOD = "total"),
		stats = getStats("n (%)"),
		labelVars = labelVars,
		file = file.path("tables", "Table_rowOrder_differentPerVar.docx")
	)

```

##### Row order based on the total of a column category

If the row categories should be **ordered by total counts for a specific
category of the column variable(s)**, a function **`rowOrderTotalFilterFct`** is
specified.

The categories of the adverse events on only the treated patients.

```{r rowOrder-filterFct}

	getSummaryStatisticsTable(
		data = dataAEInterest,
		rowVar = c("AESOC", "AEDECOD"),
		rowVarLab = labelVars[c("AEDECOD")],
		rowVarTotalInclude = c("AESOC", "AEDECOD"),
		colVar = "TRTP", colTotalInclude = TRUE,
		rowOrder = "total",
		stats = getStats("n (%)"),
		labelVars = labelVars,
		# consider only the counts of the treated patients to order the rows
		rowOrderTotalFilterFct = function(x) subset(x, TRTP == "treatmentX"),
		file = file.path("tables", "Table_rowOrder_filterFct.docx")
	)

```

##### Row order based on a custom specified function

If the method to order the rows is more complex, a function can be specified for
the`rowOrder` parameter.

For example, the adverse event table is sorted based on the counts of patient
presenting this event across all treatment classes, and in case of ties based on 
the counts of treated-patients presenting this event.

```{r countTable-LB-rowOrder-customFunction}

	library(plyr)
	getSummaryStatisticsTable(
		data = dataAEInterest,
		type = "count",
		rowVar = "AEHLT",
		rowOrder = function(x){
			x <- subset(x, !isTotal)
			totalPerCat <- daply(x, "AEHLT", function(y) sum(y$statN))# count across treatments
			totalForTreatOnly <- daply(x, "AEHLT", function(y)
				subset(y, TRTP == "treatmentX")$statN
			) # counts across treated patients
			# sort first based on overall count, then counts of treated patients
			names(totalPerCat)[order(totalPerCat, totalForTreatOnly, decreasing = TRUE)]
		},
		colVar = "TRTP", colTotalInclude = TRUE,
		labelVars = labelVars,
		title = "Table: Adverse Events ordered based on total counts",
		stats = list(expression(paste0(statN, " (", round(statPercN, 1), ")"))),
		footer = "Statistics: n (%)"
	)

```

#### Row variable labels

##### Based on dataset

The **labels used for the variables parameter** (row variables) **are
automatically extracted from the labels** contained in the _SAS_ dataset, by
specifying the `labelVars` parameter.

```{r summaryTable-PP-rowVarWithLabel-labelVars}

	# combination of rows and columns
	getSummaryStatisticsTable(
		data = dataAEInterest,
		rowVar = c("AESOC", "AEDECOD"),
		colVar = "TRTP",
		stats = getStats("n (%)"),
		labelVars = labelVars
	)
	
```

##### Custom

The label can also be specified directly via the `rowVarLab` parameter,
for each variable in `rowVar`.

If an unique row label should be used (even if multiple row variables are
specified), `rowVarLab` is set to this unique label.

```{r summaryTable-PP-rowVarWithLabel-rowVarLab}

	getSummaryStatisticsTable(
		data = dataAEInterest,
		rowVar = c("AESOC", "AEDECOD"),
		colVar = "TRTP",
		stats = getStats("n (%)"),
		rowVarLab = c(
			'AESOC' = "TEAE by SOC and Preferred Term\nn (%)"
		),
		labelVars = labelVars
	)
	
```

## Total 

### External dataset

By default, the **total per column is extracted from the number of subjects
available in the data used for the table**. If the total should be extracted
from a **different dataset**, e.g. if only a subset of the patients are present
in the data, it should be specified via the **`dataTotal`** variable (used also
for the computation of the percentage).

Note: the percentage of subjects and records is also computed based on this
`dataTotal` dataset.

For example, the total number of patients per treatment is extracted from the 
subject-level (`ADSL`) dataset. 

```{r countTable-LB-customDenominator}

	# dataset used to extract the 'Total'
	dataTotal <- dataAll$ADSL
	# should contain columns specified in 'colVar'
	dataTotal$TRTP <- dataTotal$TRT01P 
	
	getSummaryStatisticsTable(
		data = dataAEInterest,
		rowVar = c("AESOC", "AEDECOD"),
		colVar = "TRTP",
		stats = getStats("n (%)"),
		rowVarLab = c(
			'AESOC' = "TEAE by SOC and Preferred Term\nn (%)"
		),
		dataTotal = dataTotal,
		labelVars = labelVars,
		file = file.path("tables", "Table_dataTotal.docx")
	)

```

By default, this dataset is used for the total in the columns and for
the percentage in the table body.
A different dataset used for the computation of the percentage can be specified
via the `dataTotalPerc`.

### Column total

The total across all columns is included if the `colTotalInclude` is set to
TRUE.
This column is by default labelled 'Total', but this can be customized with the
`colTotalLab` parameter.

```{r colTotal}

	getSummaryStatisticsTable(
		data = dataAEInterest,
		rowVar = c("AESOC", "AEDECOD"),
		colVar = "TRTP",
		colTotalInclude = TRUE, colTotalLab = "All treatments",
		stats = getStats("n (%)"),
		rowVarLab = c(
			'AESOC' = "TEAE by SOC and Preferred Term\nn (%)"
		),
		dataTotal = dataTotal,
		labelVars = labelVars,
		file = file.path("tables", "Table_dataTotal.docx")
	)

```

### Row total

If the total should be included across elements of specific `rowVar`
variable(s), this(these) variable(s) should be included in `rowVarTotalInclude`.

For the first row variable, the total is included in the first row of the table,
with the label specified in `rowTotalLab`.

```{r rowVarTotalInclude1}

	getSummaryStatisticsTable(
		data = dataAEInterest,
		rowVar = c("AESOC", "AEDECOD"),
		rowVarTotalInclude = "AESOC", rowTotalLab = "Any AE", 
		rowVarTotalInSepRow = "Any AE",
		colVar = "TRTP",
		stats = getStats("n (%)"),
		rowVarLab = c(
			'AESOC' = "TEAE by SOC and Preferred Term\nn (%)"
		),
		dataTotal = dataTotal,
		labelVars = labelVars
	)

```

The total can also be included for each elements in the nested row variable.
In this case, the total is by default included in the header of each category
of this variable.

```{r rowVarTotalInclude2}

	getSummaryStatisticsTable(
		data = dataAEInterest,
		rowVar = c("AESOC", "AEDECOD"),
		rowVarTotalInclude = "AEDECOD", 
		colVar = "TRTP",
		stats = getStats("n (%)"),
		rowVarLab = c(
			'AESOC' = "TEAE by SOC and Preferred Term\nn (%)"
		),
		dataTotal = dataTotal,
		labelVars = labelVars
	)

```

This total can also be included as a separated category in the table, if this
variable is additionally specified in `rowVarTotalInSepRow`.

```{r rowVarTotalInclude-rowVarTotalInSepRow}

	getSummaryStatisticsTable(
		data = dataAEInterest,
		rowVar = c("AESOC", "AEDECOD"),
		rowVarTotalInclude = "AEDECOD",
		rowVarTotalInSepRow = "AEDECOD",
		colVar = "TRTP",
		stats = getStats("n (%)"),
		rowVarLab = c(
			'AESOC' = "TEAE by SOC and Preferred Term\nn (%)"
		),
		dataTotal = dataTotal,
		labelVars = labelVars
	)

```

If the total number of events should be included across all elements of a
specific row variable, this variable is specified in the the
`rowVarTotalInclude` variable.

The label for the total is customized via the `rowTotalLab` parameter.

### Remove total in column header

The total number of subjects in each column is by default included.
This is not displayed if `colHeaderTotalInclude` is set to FALSE.

```{r colHeaderTotalInclude}

	getSummaryStatisticsTable(
		data = dataAEInterest,
		rowVar = c("AESOC", "AEDECOD"),
		rowVarTotalInclude = "AEDECOD",
		rowVarTotalInSepRow = "AEDECOD",
		colVar = "TRTP",
		stats = getStats("n (%)"),
		rowVarLab = c(
			'AESOC' = "TEAE by SOC and Preferred Term\nn (%)"
		),
		dataTotal = dataTotal,
		labelVars = labelVars,
		colHeaderTotalInclude = FALSE
	)

```

## Labels

If the data is loaded into R with the `loadDataADAM` function, each column ofthe
dataframe contains a specific label in its 'label' attribute.
However, this label is lost if the object is subsetted.
In general, labels (for variable, row and column) can be specified via the
`labelVars` parameter, or specific '[parameter]Lab' parameter (e.g.
`rowVarLab`, `colVarLab`, `varLab`, ...).

## Title and footnote

```{r titleAndFooter}

	getSummaryStatisticsTable(
		data = dataAEInterest,
		rowVar = c("AESOC", "AEDECOD"),
		colVar = "TRTP",
		stats = getStats("n (%)"),
		dataTotal = dataTotal,
		labelVars = labelVars,
		title = "MOR106-CL-102: Adverse Events by System Organ Class and Preferred Term (Safety Analysis Set, Part 1)",
		footer = c(
			"N=number of subjects with data; n=number of subjects with this observation",
			"Denominator for percentage calculations = the total number of subjects per treatment group in the safety population"
		)
	)

```

## Text customization

The pharmacokinetics data is used for demonstration.

```{r data-ADSL}
	
	dataPP <- subset(dataAll$ADPP, SAFFL == "Y")
	
	# ensure that order of elements is the one specified in the corresponding numeric variable
	library(glpgUtilityFct)
	dataPP <- convertVarToFactor(
		data = dataPP, 
		var = c("PARCAT1", "PARAM", "AVISIT", "TRTP"), 
		varNum = c("PARCAT1N", "PARAMN", "AVISITN", "TRTPN")
	)
	
```	

### Superscript/subscript

Superscript and superscript are specified via the special text pattern: `a^{b}`
and subscript as `a_{b}` respectively.

To use a superscript or a subscript in
the table, the text should be formatted as:
`text^{superscript}` or `text_{subscript}`.

This is for example useful to reference additional informations in a specific
footnote or specify custom variable labels.

```{r summaryTable-PP-rowVarWithLabel-rowVarLab-superscript}

	# format labels with subscript
	paramLabelPK <- c(
		CTROUGH = "C_{trough} (ng/mL)", 
		TLAG = "t_{lag} (h)",
		TMAX = 't_{max} (h)', 
		CMAX = "C_{max} (ng/mL)",
		AUCTAU = "AUC_{0-t} (ng.h/mL)",
		AUC08H = "AUC_{0-8h} (ng.h/mL)"
	)
	dataPP$PARAMRF <- paramLabelPK[dataPP$PARAMCD]
	
	getSummaryStatisticsTable(
		data = subset(dataPP, PARCAT1 %in% c("Ivacaftor", "Lumacaftor")),
		var = "AVAL",
		colVar = "TRTP",
		rowVar = c("PARCAT1", "PARAMRF"),
		rowVarLab = c(
			'PARAMRF' = "Pharmacokinetics parameter\nfor each compound^{(1)}", # use superscript for the foonote
			'PARCAT1' = "" 
		),
		stats = list(expression(paste0(roundCustomText(statMean, 1), "\n(", roundCustomText(statSE, 2),")"))),
		# include the footnote
		footer = "(1) Each compound is labelled according to its Galapagos compound ID."
	)	

```

## Multiple table creation

Multiple tables can be created for each element of
a variable in the dataset by specifying this variable in `byVar`.

For example, pharmacokinetic tables are created for each compound:

```{r byVar}

	summaryTableList <- getSummaryStatisticsTable(
		data = subset(dataPP, PARCAT1 %in% c("Ivacaftor", "Lumacaftor")),
		var = "AVAL",
		colVar = "TRTP",
		rowVar = "PARAMRF",
		rowVarLab = c(
			'PARAMRF' = "Pharmacokinetics parameter", 
			'PARCAT1' = "Compound^{(1)}" # use superscript for the foonote
		),
		byVar = "PARCAT1", 
		labelVars = labelVars,
		stats = list(expression(paste0(roundCustomText(statMean, 1), "\n(", roundCustomText(statSE, 2),")"))),
		file = file.path("tables", "Table_byVar.docx")
	)	
	# print the list of tables in the rmarkdown document
	glpgUtilityFct::knitPrintListObjects(summaryTableList) 

```

A list of `flextable` can be included into a `rmarkdown` document with the
`knitPrintListObjects` (see [section](#outputFormat)).

## Filter records in a table

If only a subset of the records should be displayed in the final table,
a custom filtering functions is specified via the `filterFct` parameter.

```{r countTable-AE-filterFct-rowVar1}

	library(plyr)
		
	# SOC with AE terms with at least 2 subjects
	getSummaryStatisticsTable(
		data = subset(dataAE, TRTEMFL == "Y"),
		rowVar = c("AESOC", "AEDECOD"),
		rowVarLab = c('AESOC' = "TEAE by SOC and Preferred Term\nn (%)"),
		colVar = "TRTP",
		stats = getStats("n (%)"),
		filterFct = function(x)
			ddply(x, "AESOC", function(y)
				if(any(y$statN >= 2))	y			
			),
		labelVars = labelVars,
		title = "Table: Adverse Events by System Organ Class and Preferred Term with at least 2 patients in System Organ Class",
		file = file.path("tables", "Table_TEAE_filterFct_nPatientsMoreThan2.docx")
	)
	
	# AE term with at least one term with more than 25% in the treatment
	getSummaryStatisticsTable(
		data = subset(dataAE, TRTEMFL == "Y"),
		rowVar = c("AESOC", "AEDECOD"),
		rowVarLab = c('AESOC' = "TEAE by SOC and Preferred Term\nn (%)"),
		colVar = "TRTP",
		stats = getStats("n (%)"),
		filterFct = function(x)
			ddply(x, "AEDECOD", function(xTerm){
				xTermTreatment <- subset(xTerm, grepl("75 mg", TRTP))
				if(any(xTermTreatment$statPercN >= 20))	xTerm		
			}),
		labelVars = labelVars,
		title = "Table: Adverse Events by System Organ Class and Preferred Term with at least 20% patients in treatment category",
		file = file.path("tables", "Table_TEAE_filterFct_perPatientsMore20PercTreatment.docx")
	)
	
```

Note: to help for the creation of this filtering function,
the displaying data could be extracted via the `computeSummaryStatisticsTable`
function (instead of creating directly the in-text table via the
`getSummaryStatisticsTable`).

# Table format

## Report or presentation

The table can be styled via the `style` parameter.
This parameter affects the fontsize, font family, color of the text and
background, dimensions of the table.

By default, the table is styled for a CSR report.

```{r style-report}

	getSummaryStatisticsTable(
		data = dataAEInterest,
		rowVar = c("AESOC", "AEDECOD"),
		colVar = "TRTP",
		stats = getStats("n (%)"),
		dataTotal = dataTotal,
		labelVars = labelVars,
		title = "Table: Adverse Events by System Organ Class and Preferred Term",
		footer = c(
			"N=number of subjects with data; n=number of subjects with this observation",
			"Denominator for percentage calculations = the total number of subjects per treatment group in the safety population"
		),
		rowVarLab = c('AESOC' = "TEAE by SOC and Preferred Term\nn (%)"),
		file = file.path("tables", "Table_style_report.docx")
	)

```

The table can also be styled for a presentation.
In this case, the color/style follows _Galapagos_ style guidelines.

```{r style-presentation}

	getSummaryStatisticsTable(
		data = dataAEInterest,
		rowVar = c("AESOC", "AEDECOD"),
		colVar = "TRTP",
		stats = getStats("n (%)"),
		dataTotal = dataTotal,
		labelVars = labelVars,
		title = "Table: Adverse Events by System Organ Class and Preferred Term",
		footer = c(
			"N=number of subjects with data; n=number of subjects with this observation",
			"Denominator for percentage calculations = the total number of subjects per treatment group in the safety population"
		),
		rowVarLab = c('AESOC' = "TEAE by SOC and Preferred Term\nn (%)"),
		style = "presentation",
		file = file.path("tables", "Table_style_presentation.docx")
	)

```

Note: specific parameters can be used to export the table as
landscape (`landscape`), specify custom margins (`margin`), row indent
(`rowVarPadBase`), font size and family (`fontsize` and `font`).

## Details on the output format {#outputFormat}

The `getSummaryStatisticsTable` function **returns a
[`flextable`](https://cran.r-project.org/package=flextable) object (see
`?flextable`)**.

When printed into the R console, this object is displayed in the browser. This
object can be inserted within a `rmarkdown` document by printing it in the
specified document chunk. 
To include `flextable` in a `rmarkdown` document to a:

* `docx` document: pandoc version >= 2.0 is required
* `pptx` document: pandoc version >= 2.4 is required

Each table created by the `getSummaryStatisticsTable` can be exported
separately and directly into a _docx_ file if the `file` parameter is specified.

A `rmarkdown` chunk can contains only one `flextable` object. To include a list
of `flextable` in a `rmarkdown` document, the function `knitPrintListObjects` of
the `glpgUtilityFct` package can be used.

## Output the table as `data.frame`

The supporting data displayed in the `flextable` object is outputted to a R
`data.frame` if `outputType` is set to `data.frame`.

```{r outputType}

	summaryTable <- getSummaryStatisticsTable(
		data = dataAEInterest,
		rowVar = c("AESOC", "AEDECOD"),
		colVar = "TRTP",
		stats = getStats("n (%)"),
		dataTotal = dataTotal,
		labelVars = labelVars,
		title = "Table: Adverse Events by System Organ Class and Preferred Term",
		footer = c(
			"N=number of subjects with data; n=number of subjects with this observation",
			"Denominator for percentage calculations = the total number of subjects per treatment group in the safety population"
		),
		rowVarLab = c('AESOC' = "TEAE by SOC and Preferred Term\nn (%)"),
		style = "presentation",
		outputType = "data.frame"
	)
	pander(summaryTable)

```

# Data pre-processing

The variables used for the row and columns of the summary statistics tables
should be present in a long format in the input data for
the `getSummaryStatisticsTable` function.

In case the grouping of the rows/columns is more complex and no
grouping variable is yet available in the data,
the function `combineVariables` offers simpler functionalities to
create the input data.

The label for the grouping is extracted from the SAS dataset labels if
`labelVars` is specified, or can be customized (`label` parameter).

For example, the adverse events are counted for different population set:
screened population, completer population, only events with high severity,
or related to the treatment and with high severity.

```{r combineVariables}

	# prepare the data: create grouping of interest
	dataAEGroup <- combineVariables(
		data = dataAEInterest,
		newVar = "AEGRP",
		paramsList = list(
			# for all screened patients
			list(var = "SCRNFL", value = "Y"),
			# only for completers patients
			list(var = "COMPLFL", value = "Y"),
			# for high severity
			list(var = "AESEVN", value = 2, fctTest = ">=", labelExtra = "higher than 2"),
			# treatment-emergent and with higher severity
			list(
				exprs = 'AREL == "Related" & AESEVN >= 2',
				label = paste(
					labelVars["AREL"], 
					"with", labelVars["AESEV"], "higher than 2"
				)
			),
			list(var = "AENDY", label = paste("With adverse events ending date"))
		),
		# include also counts for all records
		includeAll = TRUE, labelAll = "All Adverse events", 
		labelVars = labelVars
	)
	labelVars["AEGRP"] <- "Patient groups of interest"
	
	# create the table
	getSummaryStatisticsTable(
		data = dataAEGroup,
		colVar = "TRTP", 
		rowVar = "AEGRP", 
		labelVars = labelVars,
		dataTotal = dataTotal,
		stats = list(expression(paste0(statN, " (", round(statPercN, 1), ")"))),
		title = "Table: Adverse events: counts for groups of interest",
		footer = "Statistics: n (%)"
	)

```

<!-- # TODO -->

# Use cases

## Demographics table

```{r useCase-demoTable}

	# data of interest
	dataDM <- subset(dataAll$ADSL, SAFFL == "Y")
	
	# variables of interest
	varsDMNum <- c("AGE", "HEIGHT", "WEIGHTBL", "BMIBL")
	varsDMCat <- c("RACE", "SEX")
	varsDM <- c(varsDMNum, varsDMCat)
	
	# order categorical variables according to their numeric variable
	dataDM <- convertVarToFactor(
		data = dataDM,
		var = c("SEX", "RACE"),
		varNum = c("SEXN", "RACEN")
	)
	dataDM$ACTARMCD <- with(dataDM, reorder(ACTARM, ACTARMCD, unique))
	
	# create the table
	getSummaryStatisticsTable(
		data = dataDM, 
		var = varsDM,
		varGeneralLab = "Parameter",
		statsGeneralLab = "",
		colVar = "ACTARM", colTotalInclude = TRUE,
		rowVarTotalPerc = "variable",
		statsLayout = "row",
		labelVars = labelVars,
		rowAutoMerge = TRUE,
		title = "Table: demographic data and baseline characteristics",
		footer = "N=number of subjects with data; n=number of subjects with this observation",
		file = file.path("tables", "Table_DemographicData.docx")
	)
	
```

## Laboratory abnormalities

The laboratory parameters are grouped by category, and the visit is indicated in
the rows: `PARCAT1`, `PARCAT2` and `AVISIT` are specified in `rowVar`. The
treatment is reported in the column: `TRTP` specified in `colVar`.

Because the laboratory measurement reported as normal or empty ('') in the ADaM
are not of interest, these classes are filtered via the `varIgnore` parameter.

By default, the number ('N') and percentage ('Perc') are reported for each
`rowVar`/`colVar`.

```{r example-countTable-LB}

	dataLB <- subset(dataAll$ADLB, AN01FL == "Y")
	
	# ensure that order of elements is the one specified in the corresponding numeric variable
	library(glpgUtilityFct)
	dataLB[dataLB[, "PARCAT2"] == "", "PARCAT2"] <- "OTHER"
	dataLB <- convertVarToFactor(
		data = dataLB, 
		var = c("PARCAT1", "PARCAT2", "AVISIT", "TRTP", "ANRIND"), 
		varNum = c("PARCAT1N", "PARCAT2N", "AVISITN", "TRTPN", "ANRINDN")
	)
	
	# only consider abnormalities
	dataLB <- subset(dataLB, !ANRIND %in% c("", "L"))
	
	# specific analysis visits
	dataLB <- subset(dataLB, AVISIT %in% c("Baseline", "Day 14", "Day 28", "Follow-up"))
	
	dataLB$ANRIND <- factor(dataLB$ANRIND, 
		levels = c('L', 'N', 'H', 'H+L'),
		labels = c("Low", "Normal", "High", "High+Low")
	)
	
	# create summary table
	getSummaryStatisticsTable(
		data = dataLB,
		rowVar = c("PARCAT1", "PARCAT2", "PARAM", "ANRIND"),
		rowVarInSepCol = "ANRIND",
		rowVarLab = c(PARAM = "Laboratory Parameter\nn (%)", labelVars["ANRIND"]),
		colVar = c("TRTP", "AVISIT"),  
		type = "count",
		labelVars = labelVars,
		stats = getStats("n (%)"),
		title = "Table: Laboratory abnormalities",
		footer = "Statistics: n (%)",
		landscape = TRUE,
		file = file.path("tables", "Table_LB.docx")
	)

```

## Adverse events

```{r example-countTable-AE}

	dataAEInterest <-  subset(dataAll$ADAE, FASFL == "Y")
	
	# ensure that order of elements is the one specified in the corresponding numeric variable
	library(glpgUtilityFct)
	dataAEInterest <- convertVarToFactor(
		data = dataAEInterest, 
		var = "TRTP", 
		varNum = "TRTPN"
	)

	# dataset used to extract the 'Total'
	dataTotal <- dataAll$ADSL
	# should contain columns specified in 'colVar'
	dataTotal$TRTP <- dataTotal$TRT01P 
	
	getSummaryStatisticsTable(
		data = dataAEInterest,
		type = "count",
		rowVar = c("AEHLGT", "AEHLT", "AELLT"),
		colVar = "TRTP",
		labelVars = labelVars,
		title = "Table: Adverse Events",
		dataTotal = dataTotal,
		rowVarTotalInclude = "AEHLGT",
		stats = list(expression(paste0(statN, " (", round(statPercN, 1), ")"))),
		footer = "Statistics: n (%)",
		file = "summaryStatisticsTable_AE_count.docx",
	)

```

## Pharmacokinetic parameters

```{r example-PP}

	# format labels with subscript
	paramLabelPK <- c(
		CTROUGH = "C_{trough} (ng/mL)", 
		TLAG = "t_{lag} (h)",
		TMAX = 't_{max} (h)', 
		CMAX = "C_{max} (ng/mL)",
		AUCTAU = "AUC_{0-t} (ng.h/mL)",
		AUC08H = "AUC_{0-8h} (ng.h/mL)"
	)
	dataPP$PARAMRF <- paramLabelPK[dataPP$PARAMCD]
	
	# for each PK parameter: number of decimals if max number dicmals of AVAL based on:
	# 2 decimals for values < 10
	# 1 decimal for values > 10 and < 1000
	# No decimals for value > 1000.
	customNDec <- function(x)	ifelse(x > 1000, 0, ifelse(x > 10, 1, 2))
	nMaxDec <- daply(dataPP, "PARAMRF", function(x) max(customNDec(x$AVAL), na.rm = TRUE))
	
	# Values are arithmetic mean (CV%) except median (min-max) for tmax
	# [mean, median]: + 1 digit
	nMaxDecTMax <- unname(nMaxDec[paramLabelPK["TMAX"]])
	statsPP <- sapply(nMaxDec, function(nMaxDec){
		list(
			bquote(
				ifelse(statMean == 0, 0, paste0(
						roundCustomText(statMean, .(nMaxDec + 1)), " (",
						roundCustomText(statCVPerc, .(nMaxDec)), ")"
					)
				)
			)
		)
	}, simplify = FALSE)
	
	getSummaryStatisticsTable(
		data = subset(dataPP, PARCAT1 %in% c("Ivacaftor", "Lumacaftor")),
		var = "AVAL",
		colVar = "TRTP",
		rowVar = c("PARCAT1", "PARAMRF"),
		rowVarLab = c(
			'PARAMRF' = "Pharmacokinetics parameter\nfor each compound^{(1)}", # use superscript for the foonote
			'PARCAT1' = "" 
		),
		statsExtra = list(statCVPerc = cv),
		stats = statsPP, statsVarBy = "PARAMRF",
		# include the footnote
		footer = c(
			"Mean (CV%) indicated for each parameter.",
			"(1) Each compound is labelled according to its Galapagos compound ID."
		),
		file = file.path("tables", "Table_superscriptSubscriptTitleFootnote.docx"),
		title = "Table: PK Parameters (Safety Analysis Set)"
	)	

```

## Mock-up tables

```{r mockUpTables}

	# create summary table
	getSummaryStatisticsTable(
		data = subset(dataLB, PARCAT2 %in% c("ENZYMES", "LIPIDS")),
		rowVar = c("PARCAT1", "PARCAT2", "PARAM", "ANRIND"),
		rowVarInSepCol = "ANRIND",
		colVar = c("TRTP", "AVISIT"),  
		type = "count",
		labelVars = labelVars,
		rowVarLab = c(PARAM = "Parameter", labelVars["ANRIND"]),
		stats = list(expression(paste0("[X.XX]"))),
		title = "Table: Treatment-emergent laboratory abnormalities (mock-up)",
		footer = "Statistics: n (%)",
		landscape = TRUE,
		file = file.path("tables", "Table_mockUp.docx")
	)

```


# Visualization

Summary statistics can be visualized via **error bars** by:

* extracting the summary statistics table with the
  `computeSummaryStatisticsTable` function (used for `getSummaryStatistics` function)
* visualizing the summary statistics via the `subjectProfileSummaryPlot`
  function

```{r visualization, out.width = "100%", fig.height = 6, fig.width = 9}

	summaryTableDf <- computeSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		rowVar = "PARAM",
		colVar = c("TRTP", "AVISIT")
	)

	# create the plot
	subjectProfileSummaryPlot(
		data = subset(summaryTableDf, !isTotal),
		xVar = "AVISIT",
		colorVar = "TRTP",
		labelVars = labelVars,
		facetVar = "PARAM",
		useLinetype = TRUE
	)

```

# Appendix

## Session information

```{r includeSessionInfo, echo = FALSE}

	pander(sessionInfo())

```
