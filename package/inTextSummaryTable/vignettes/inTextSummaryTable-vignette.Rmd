---
title: "Vignette of the `inTextSummaryTable` package"
author: "Laure Cougnaud"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float:
      collapsed: true
    toc_depth: 4
    number_sections: true
vignette: >
  %\VignetteIndexEntry{inTextSummaryTable package}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# Introduction

```{r options, echo = FALSE}
	
	library(knitr)
	opts_chunk$set(
		echo = TRUE, results = 'asis', warning = FALSE, 
		error = FALSE, message = FALSE, cache = FALSE,
		fig.width = 8, fig.height = 7,
		fig.path = "./figures_vignette/",
		#out.width = '0.7\\textwidth', 
		fig.align = 'center')#, out.height = 0.5\\textwidth', fig.path = 'graphs/') 
	options(width = 170)#, stringsAsFactors = FALSE
	options(warn = 1)#instead of warn = 0 by default -> to have place where warnings occur in the call to Sweave function
	
```

The package `inTextSummaryTable` contains functionalities to **create table of
summary statistics or counts of metrics of interest**, to **format them as
in-text table**, and to **export them to a`docx` document**.

```{r loadPackages}

	library(pander)
	library(inTextSummaryTable)

```

## Data format

The input data for the creation of summary table should be a **data.frame**,
usually loaded from _SAS_ data file (`sas7bdat` format).
The label of the variables stored in the `SAS` datasets is also used
for the title/captions. 

Example datasets from the _Pelican_ study included in the
`inTextSummaryTable` package itself are used in this vignette.  

Note that the `loadDataADaMSDTM` function of the `glpgUtilityFct` package can
be used to your custom `SAS` dataset(s) of interest.

```{r loadData}	
	
	# load example data
	data(ADaMDataPelicanInText)
	data(labelVarsADaMPelicanInText)
	
	dataAll <- ADaMDataPelicanInText
	labelVars <- labelVarsADaMPelicanInText

```

# Summary table

The main workhorse function is: **`getSummaryStatisticsTable`** which creates an
in-text table of summary statistics for variable(s) of interest.

Two types of table can be created: a **count table for discrete variable**
(integer, factor, character) to indicate the counts of the number of subjects or
records per category of interest or **a summary statistics table** to indicate
**standard distribution statistics (mean, median, minimum, maximum, standard
error, standard deviation, and count statistics) for a numeric variable**.

By default, the type of the table is **automatically detected** based on the
variable type. This can also be specified via the `type` parameter set to:
`summaryTable`, `countTable` or `auto` (by default).

Note: all functionalities described below for the summary statistics table are
also available for the count table (and vice versa).

## Summary statistics

The functionalities of the `getSummaryStatisticsTable` is demonstrated for the
summary statistics table.

### General

The _Pharmacokinetics_ data (`ADPP` dataset) is used as example for the summary
statistics table.

```{r summaryTable-PP-data}

	dataPP <- dataAll$ADPP
	
	# ensure that order of elements is the one specified in the corresponding numeric variable
	library(glpgUtilityFct)
	dataPP <- convertVarToFactor(
		data = dataPP, 
		var = c("PARCAT1", "PARAM", "AVISIT", "TRTP"), 
		varNum = c("PARCAT1N", "PARAMN", "AVISITN", "TRTPN")
	)

```

The variable to summarize is specified via the `var`
parameter. For the summary statistics table, this variable should be numeric.
**By default, an
entire set of summary statistical metrics are computed**, see
`?computeSummaryStatisticsTable` for the list of metrics.

```{r summaryTable-PP-simple}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL"
	)

```

### Row variable(s)

Specific grouping variable(s) for the rows can be specified via the
**`rowVar`** parameter.

For example, the summary statistics are computed for each `r labelVars["PARAM"]`
(`PARAM` parameter).

```{r summaryTable-PP-rowVar}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		rowVar = "PARAM"
	)
	
```

Grouping for the rows can be specified via **multiple nested variables** to the
`rowVar` parameter, which should be sorted in hierarchical order.

The `rowPadBase` parameter can be used to change the padding between each row
level.

```{r summaryTable-PP-rowVarMultiple}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		rowVar = c("PARCAT1", "PARAM"),
		rowPadBase = 10
	)
	
```

### Column variable(s)

Similarly, column(s) of interest are specified via the **`colVar`** parameter.
The total is included for each column in the header.

```{r summaryTable-PP-colVar}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = "TRTP"
	)
	
```

```{r summaryTable-PP-colVarMultiple}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = c("TRTP", "AVISIT")
	)
	
```

### Row and column combinations

```{r summaryTable-PP-rowColVar}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = c("TRTP", "AVISIT"),
		rowVar = c("PARCAT1", "PARAM")
	)
	
```

### Row variable labels

#### Based on dataset

The **labels used for the variables parameter** (row variables) **are
automatically extracted from the labels** contained in the _SAS_ dataset, by
specifying the `labelVars` parameter.

```{r summaryTable-PP-rowVarWithLabel-labelVars}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = c("TRTP", "AVISIT"),
		rowVar = c("PARCAT1", "PARAM"),
		labelVars = labelVars
	)
	
```

#### Custom

The label can also be specified directly via the `rowVarLab` parameter.

```{r summaryTable-PP-rowVarWithLabel-rowVarLab}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = c("TRTP", "AVISIT"),
		rowVar = c("PARCAT1", "PARAM"),
		rowVarLab = c('PARAM' = "Pharmacokinetics parameter", 'PARCAT1' = "Compound")
	)
	
```

#### Use of superscript in variable labels 

To use a superscript in the variable label, e.g. to reference additional
information in a specific footnote, the text should be formatted as:
`text^{superscript}`.

```{r summaryTable-PP-rowVarWithLabel-rowVarLab-superscript}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = c("TRTP", "AVISIT"),
		rowVar = c("PARCAT1", "PARAM"),
		rowVarLab = c(
			'PARAM' = "Pharmacokinetics parameter", 
			'PARCAT1' = "Compound^{(1)}" # use superscript for the foonote
		),
		# include the footnote
		footer = "(1) Each compound is labelled according to its Galapagos compound ID."
	)	

```

### Statistics

For each element of the row and column variables, a set of summary statistics is
computed, see documentation of the `stats` parameter for the
`getSummaryStatisticsTable` function for more details.

#### Custom statistics

**These statistics can be combined and the format can be customized via the
`stats` parameter** (`expression` or `call` object). 

If an unique statistic expression is specified, the 'Statistic' column doesn't
appear in the table. In case multiple statistics are specified, these are
included
as multiple rows for each row group specified in `rowVar`.

For example, the summary table is restricted to the mean+-SE statistics.

```{r summaryTable-PP-meanSE}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = c("TRTP", "AVISIT"),
		rowVar = c("PARCAT1", "PARAM"),
		labelVars = labelVars,
		stats = list(expression(paste(formatC(statMean), "+-", formatC(statSE)))),
		footer = "Statistics: mean +- SE",
		rowPadBase = 10
	)

```

Multiple statistics can be specified.

```{r summaryTable-PP-medianMinMax}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = c("TRTP", "AVISIT"),
		rowVar = c("PARCAT1", "PARAM"),
		labelVars = labelVars,
		stats =  list(
			Mean = expression(formatC(statMean)),
			Median = expression(formatC(statMedian))
		),
		footer = "Statistics: median (min, max)",
		statsLayout = "col",
		rowPadBase = 10
	)

```

#### Statistics layout

The layout of the statistics is specified via the `statsLayout` parameter.
By default, the statistics are included in rows, after each element of the row
variable(s).

```{r summaryTable-PP-medianMinMax-statsLayoutRow}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = c("TRTP", "AVISIT"),
		rowVar = c("PARCAT1", "PARAM"),
		labelVars = labelVars,
		stats =  list(
			Mean = expression(formatC(statMean)),
			Median = expression(formatC(statMedian))
		),
		footer = "Statistics: median (min, max)",
		statsLayout = "row",
		rowPadBase = 10
	)

```

The statistics can also be included in columns.

```{r summaryTable-PP-medianMinMax-statsLayoutCol}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = c("TRTP", "AVISIT"),
		rowVar = c("PARCAT1", "PARAM"),
		labelVars = labelVars,
		stats =  list(
			Mean = expression(formatC(statMean)),
			Median = expression(formatC(statMedian))
		),
		footer = "Statistics: median (min, max)",
		statsLayout = "col",
		rowPadBase = 10
	)

```

The statistics can also be specified in rows, but in a column separated from
the row variables.

```{r summaryTable-PP-medianMinMax-statsLayoutRowVarInSepCol}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = c("TRTP", "AVISIT"),
		rowVar = c("PARCAT1", "PARAM"),
		labelVars = labelVars,
		stats =  list(
			Mean = expression(formatC(statMean)),
			Median = expression(formatC(statMedian))
		),
		footer = "Statistics: median (min, max)",
		statsLayout = "rowInSepCol",
		rowPadBase = 10
	)

```

### Row as separated columns

**Row variables** that shouldn't be included in the unique column with the row
variables, but as **separated column** are additionally specified via the
`rowVarInSepCol` parameter.

```{r summaryTable-PP-rowVarInSepCol}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = c("TRTP", "AVISIT"),
		rowVar = c("PARCAT1", "PARAM"),
		rowVarInSepCol = "PARAM",
		labelVars = labelVars,
		stats =  list(expression(paste0(formatC(statMedian), 
			" (", formatC(statMin), ", ", formatC(statMin), ")"))
		),
		footer = "Statistics: median (min, max)"
	)
	
```

### Summary statistics across columns

The **summary statistics across categories of the column variable**
are included via the parameter `colTotalInclude` set to TRUE.

```{r summaryTable-PP-colTotal}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = "TRTP",
		rowVar = c("PARCAT1", "PARAM"),
		labelVars = labelVars,
		colTotalInclude = TRUE,
		stats = list(expression(paste(formatC(statMean), "+-", formatC(statSE)))),
		footer = "Statistics: mean +- SE",
		rowPadBase = 10
	)

```

### Multiple variables

Multiple variables to be summarized can be specified in the `var` parameter.

```{r summaryTable-multipleVariables}

	getSummaryStatisticsTable(
		data = subset(dataAll$ADLB, FASFL == "Y" & PARCAT1 == "CHEMISTRY"),
		var = c("AVAL", "CHG"),
		rowVar = c("PARCAT2", "PARAM"),
		colVar = c("TRTP", "AVISIT"),
		stats = list(expression(paste(formatC(statMean), "+-", formatC(statSE)))),
		rowPadBase = 10,
		labelVars = labelVars,
		title = "Analysis value and change from baseline of the Chemical parameters"
	)

```

## Count table

Count table are obtained by specifying the **`type` parameter to 'countTable'**.
If **no variable is specified** (`var` parameter), the number of
subjects/records are counted in the **entire dataset**.
If a **variable is specified**, the **counts of each sub-category/class** of the
specified variable are extracted.

The adverse event dataset is used as an example.

```{r countTable-AE-data}

	dataAE <-  subset(dataAll$ADAE, FASFL == "Y")
	
	# ensure that order of elements is the one specified in the corresponding numeric variable
	library(glpgUtilityFct)
	dataAE <- convertVarToFactor(
		data = dataAE, 
		var = "TRTP", 
		varNum = "TRTPN"
	)

```

### General

By default, a set of custom statistics are computed, see the
`? computeSummaryStatisticsTable` for further details.

```{r countTable-AE-simple}

	getSummaryStatisticsTable(
		data = dataAE,
		type = "count"
	)

```	

### Extra functionalities

All functionalities provided for the summary statistics table are also available
for the count table.  

In the following example: the counts of subjects and records for the adverse
events are reformatted as: 'N (%)' and 'm' with the `stats` parameter, and the
adverse event term are grouped according to the `r labelVars["AEHLGT"]`
('AEHLGT) and `r labelVars["AEHLT"]` ('AEHLT') variable.

```{r countTable-AE-extra}

	getSummaryStatisticsTable(
		data = dataAE,
		type = "count",
		rowVar = c("AEHLGT", "AEHLT", "AELLT"),
		colVar = "TRTP",
		labelVars = labelVars,
		rowPadBase = 10,
		title = "Table: Adverse Events",
		stats = list(
			'N (%)' = expression(paste0(statN, " (", round(statPercN, 1), ")")),
			'm' = expression(statm)
		),
		footer = "Statistics: number and percentage of subjects: N (%) and number of records: m"
	)

```	

### External dataset for total counts

#### Based on subject ID only

By default, the **total per column is extracted from
the number of subjects available in the data used for the table**. If the total
should be extracted from a **different dataset**, e.g. if only a subset of the
patients are present in the data, it should be specified via the **`dataTotal`**
variable (used also for the computation of the percentage).

Note: the percentage of subjects and records is also computed based on this
`dataTotal` dataset.

For example, the total number of patients per treatment is extracted from the 
subject-level (`ADSL`) dataset. 

```{r countTable-LB-customDenominator}

	# dataset used to extract the 'Total'
	dataTotal <- dataAll$ADSL
	# should contain columns specified in 'colVar'
	dataTotal$TRTP <- dataTotal$TRT01P 
	
	getSummaryStatisticsTable(
		data = dataAE,
		type = "count",
		rowVar = c("AEHLGT", "AEHLT", "AELLT"),
		colVar = "TRTP",
		labelVars = labelVars,
		rowPadBase = 10,
		title = "Table: Adverse Events",
		dataTotal = dataTotal,
		stats = list(expression(paste0(statN, " (", round(statPercN, 1), ")"))),
		footer = "Statistics: N (%)"
	)

```

### Total count of events across rows

#### Entire table

The **total number of events across the entire table per column** is included if
the parameter **`rowTotalInclude`** is set to TRUE.

The label for the total is customized via the `rowTotalLab` parameter.

```{r countTable-LB-rowTotalInclude}

	# dataset used to extract the 'Total'
	dataTotal <- dataAll$ADSL
	# should contain columns specified in 'colVar'
	dataTotal$TRTP <- dataTotal$TRT01P 
	
	getSummaryStatisticsTable(
		data = dataAE,
		type = "count",
		rowVar = c("AEHLGT", "AEHLT", "AELLT"),
		colVar = "TRTP",
		labelVars = labelVars,
		rowPadBase = 10,
		title = "Table: Adverse Events",
		dataTotal = dataTotal,
		rowTotalInclude = TRUE, rowTotalLab = "Any adverse events",
		stats = list(expression(paste0(statN, " (", round(statPercN, 1), ")"))),
		footer = "Statistics: N (%)"
	)

```

#### Per group of the row variable

The total for **each sub-group of the row variable(s)** is now included via the
parameter **`rowSubtotalInclude`**.

```{r countTable-LB-rowSubtotalInclude}
	
	getSummaryStatisticsTable(
		data = dataAE,
		type = "count",
		rowVar = c("AEHLGT", "AEHLT", "AELLT"),
		colVar = "TRTP",
		labelVars = labelVars,
		rowPadBase = 10,
		title = "Table: Adverse Events",
		dataTotal = dataTotal,
		rowSubtotalInclude = TRUE,
		stats = list(expression(paste0(statN, " (", round(statPercN, 1), ")"))),
		footer = "Statistics: N (%)"
	)

```

### Empty rows/columns

The parameters **`rowInclude0` and `colInclude0`**
are set to TRUE to **include statistics for empty categories**.
These categories are specified via additional **levels in a factor variable**.

For example, the table of adverse events for white blood
cell analysis is created with an additional dummy treatment category (in
column) and extra analysis (in row)
category.

```{r countTable-LBWhiteBlood-emptyVars}

	## only consider White blood cell adverse events
	dataAEWBCA <- subset(dataAE, AEHLT == "White blood cell analyses")
	
	## create dummy categories for:
	# treatment
	dataAEWBCA$TRTP <- with(dataAEWBCA, 
		factor(TRTP, levels = c(unique(as.character(TRTP)), "Treatment B"))
	)
	# low-level term category
	dataAEWBCA$AELLT <- with(dataAEWBCA, 
		factor(AELLT, levels = c(unique(as.character(AELLT)), "Lymphocyte percentage increased"))
	)
	
	# create summary statistics table
	getSummaryStatisticsTable(
		data = dataAEWBCA,
		type = "count",
		rowVar = "AELLT",
		rowInclude0 = TRUE, colInclude0 = TRUE,
		colVar = "TRTP",
		labelVars = labelVars,
		rowPadBase = 10,
		title = "Table: Adverse Events: white blood cell analyses",
		dataTotal = dataTotal,
		stats = list(expression(paste0(statN, " (", round(statPercN, 1), ")"))),
		footer = "Statistics: N (%)"
	)

```

### Table filtering

#### Based on row variable

Only the AE categories occurring in at least 2 patients in at least one of the
low-level AR category are retained.

```{r countTable-AE-filterFct-rowVar1}

	library(plyr)
	filterFct <- function(x){
		ddply(x, "AELLT", function(y)
			if(any(y$statN >= 2)) y
		)
	}
		
	getSummaryStatisticsTable(
		data = dataAE,
		type = "count",
		rowVar = c("AEHLGT", "AEHLT", "AELLT"),
		colVar = "TRTP",
		labelVars = labelVars,
		filterFct = filterFct,
		rowPadBase = 10,
		title = "Table: Adverse Events",
		stats = expression(paste0(statN, " (", round(statPercN, 1), ")")),
		footer = "Statistics: number and percentage of subjects: N (%)"
	)

```

#### Based on row and column variable

Only the AE categories occurring in at least 2 treated-patients in at least one
of the low-level AR category are retained.

```{r countTable-AE-filterFct-rowColVar}

	filterFct <- function(x){
		ddply(x, "AELLT", function(y)
			if(any(subset(y, TRTP == "treatmentX")$statN >= 2))	y
		)
	}
		
	getSummaryStatisticsTable(
		data = dataAE,
		type = "count",
		rowVar = c("AEHLGT", "AEHLT", "AELLT"),
		colVar = "TRTP",
		labelVars = labelVars,
		filterFct = filterFct,
		rowPadBase = 10,
		title = "Table: Adverse Events",
		stats = expression(paste0(statN, " (", round(statPercN, 1), ")")),
		footer = "Statistics: number and percentage of subjects: N (%)"
	)

```

### Row ordering

The **categories in the row variables can be ordered** based on the
**`rowOrder`** variable. 

This variable is either:

* a string with the name of an implemented method to order the rows, among:
     + `alphabetical`: categories are ordered **alphabetically**
     + `auto`: order of the categories in the **input variable** (factor levels) 
are retained (ordered alphabetically if not specified), e.g. to use a fixed
       ordering
     + `total`: categories are ordered based on the **total of
  the sub-category**
* a custom ordering function to apply in the data to order the rows

#### Common order for all row variables

```{r countTable-LB-rowOrder-common}
	
	getSummaryStatisticsTable(
		data = dataAE,
		type = "count",
		rowVar = c("AEHLGT", "AEHLT", "AELLT"),
		rowOrder = "total",
		colVar = "TRTP",
		labelVars = labelVars,
		rowPadBase = 10,
		title = "Table: Adverse Events ordered based on total counts",
		dataTotal = dataTotal,
		rowSubtotalInclude = TRUE,
		stats = list(expression(paste0(statN, " (", round(statPercN, 1), ")"))),
		footer = "Statistics: N (%)"
	)

```

#### Different orders for each row variable

In case the order should be different for each row variable, a named list is
provided for the `rowVar` parameter.

```{r countTable-LB-rowOrder-specific}
	
	dataAERowOrderByVar <- dataAE
	
	# order AE high-level term based on the code
	dataAERowOrderByVar <- convertVarToFactor(
		data = dataAERowOrderByVar, 
		var = "AEHLGT", varNum = "AEHLGTCD"
	)

	getSummaryStatisticsTable(
		data = dataAERowOrderByVar,
		type = "count",
		rowVar = c("AEHLGT", "AEHLT", "AELLT"),
		rowOrder = list(AEHLGT = "auto", 'AEHLT' = "total", AELLT = "alphabetical"),
		colVar = "TRTP",
		labelVars = labelVars,
		rowPadBase = 10,
		title = "Table: Adverse Events ordered based on total counts of high-level category",
		dataTotal = dataTotal,
		rowSubtotalInclude = TRUE,
		stats = list(expression(paste0(statN, " (", round(statPercN, 1), ")"))),
		footer = "Statistics: N (%)"
	)

```

#### Row order based on the total of a column category

If the row categories should be **ordered by total counts for a specific
category of the column variable(s)**, a function **`rowOrderTotalFilterFct`** is
specified.

The categories of the adverse events of upper respiratory tract infections are
sorted based on their occurrence on only the treated patients.

```{r countTable-LB-rowOrder-filterFct}

	dataAERowOrderFilterFct <- subset(dataAE, AEHLT == "Upper respiratory tract infections")
	getSummaryStatisticsTable(
		data = dataAERowOrderFilterFct,
		type = "count",
		rowVar = "AELLT",
		rowOrder = "total",
		colVar = "TRTP",
		labelVars = labelVars,
		rowPadBase = 10,
		# consider only the counts of the treated patients to order the rows
		rowOrderTotalFilterFct = function(x) subset(x, TRTP == "treatmentX"),
		title = "Table: Adverse Events ordered based on total counts",
		dataTotal = dataTotal,
		stats = list(expression(paste0(statN, " (", round(statPercN, 1), ")"))),
		footer = "Statistics: N (%)"
	)

```

#### Row order based on a custom specified function

If the method to order the rows is more complex, a function can be
specified for the`rowOrder` parameter.

For example, the adverse event table is sorted based on the counts of patient
presenting this event across all treatment classes, and in case of ties based on 
the counts of treated-patients presenting this event.

```{r countTable-LB-rowOrder-customFunction}

	getSummaryStatisticsTable(
		data = dataAE,
		type = "count",
		rowVar = "AEHLT",
		rowOrder = function(x){
			x <- subset(x, !isTotal)
			totalPerCat <- daply(x, "AEHLT", function(y) sum(y$statN))# count across treatments
			totalForTreatOnly <- daply(x, "AEHLT", function(y)
				subset(y, TRTP == "treatmentX")$statN
			) # counts across treated patients
			# sort first based on overall count, then counts of treated patients
			names(totalPerCat)[order(totalPerCat, totalForTreatOnly, decreasing = TRUE)]
		},
		colVar = "TRTP", colTotalInclude = TRUE,
		labelVars = labelVars,
		rowPadBase = 10,
		title = "Table: Adverse Events ordered based on total counts",
		dataTotal = dataTotal,
		stats = list(expression(paste0(statN, " (", round(statPercN, 1), ")"))),
		footer = "Statistics: N (%)"
	)

```

### Multiple summary tables

Multiple summary table for different elements of a specific variable are created
at once with the `byVar` variable.

```{r countTable-AE-byVar}
		
	dataAEByVar <- subset(dataAE, AEHLGT %in% c(
		"Infections - pathogen unspecified",
		"Respiratory disorders NEC"
	))
	summaryTables <- getSummaryStatisticsTable(
		data = dataAEByVar,
		type = "count",
		rowVar = c("AEHLT", "AELLT"),
		byVar = "AEHLGT", 
		colVar = "TRTP", colTotalInclude = TRUE,
		labelVars = labelVars,
		rowPadBase = 10,
		title = "Table: Adverse Events",
		dataTotal = dataTotal,
		stats = list(expression(paste0(statN, " (", round(statPercN, 1), ")"))),
		footer = "Statistics: N (%)"
	)
	summaryTables[[1]]
	summaryTables[[2]]

```

## Mixed table

Summary statistics can be included for a **mixed table**, i.e. containing
**both numeric and discrete variables**.

The variable type is automatically detected by the function.

```{r mixedTable-SL}

	customStatsCat <- expression(paste0(statN, " (", round(statPercN, 1), ")"))
	customStatsNum <- expression(paste0(formatC(statMean), "+-", formatC(statSE)))
	
	# TODO: check horizontal lines
	getSummaryStatisticsTable(
		data = dataAll$ADSL,
		colVar = "TRT01P", 
		stats = list(
			RACE = customStatsCat, AGE = customStatsNum, SEX = customStatsCat,
			WEIGHTBL = customStatsNum, HEIGHT = customStatsNum,
			BMIBLGR1 = customStatsCat, SMOKE = customStatsCat
		),
		var = c("RACE", "AGE", "SEX", "WEIGHTBL", "HEIGHT", "BMIBLGR1", "SMOKE"),
		varLabGeneral = "Characteristic", varLabSubgroup = "Class",
		labelVars = labelVars,
		rowPadBase = 10,
		title = "Demographic table",
	)

```

## Data pre-processing

The variables used for the row and columns of the summary statistics tables
should be present in a long format in the input data for
the `getSummaryStatisticsTable` function.

In case the grouping of the rows/columns is more complex and no
grouping variable is yet available in the data,
the function `combineVariables` offers simpler functionalities to
create the input data.

The label for the grouping is extract from the SAS dataset labels if `labelVars`
is specified, or can be customized (`label` parameter).

For example, the adverse events are counted for different population set:
screened population, completer population, only events with high severity,
or related to the treatment and with high severity.

```{r combineVariables}

	# prepare the data: create grouping of interest
	dataAEGroup <- combineVariables(
		data = dataAE,
		newVar = "AEGRP",
		paramsList = list(
			# for all screened patients
			list(var = "SCRNFL", value = "Y"),
			# only for completers patients
			list(var = "COMPLFL", value = "Y"),
			# for high severity
			list(var = "AESEV", value = 2, fctTest = ">=", labelExtra = "higher than 2"),
			# treatment-emergent and with higher severity
			list(
				exprs = 'AREL == "Related" & AESEVN >= 2',
				label = paste(
					labelVars["AREL"], 
					"with", labelVars["AESEV"], "higher than 2"
				)
			),
			list(var = "AENDY", label = paste("With adverse events ending date"))
		),
		# include also counts for all records
		includeAll = TRUE, labelAll = "All Adverse events", 
		labelVars = labelVars
	)
	labelVars["AEGRP"] <- "Patient groups of interest"
	
	# create the table
	getSummaryStatisticsTable(
		data = dataAEGroup,
		colVar = "TRTP", 
		rowVar = "AEGRP", 
		varLabGeneral = "Characteristic", varLabSubgroup = "Class",
		labelVars = labelVars,
		rowPadBase = 5,
		dataTotal = dataTotal,
		stats = list(expression(paste0(statN, " (", round(statPercN, 1), ")"))),
		title = "Table: Adverse events: counts for groups of interest",
		footer = "Statistics: N (%)"
	)

```

# Use cases

## Laboratory abnormalities

The laboratory parameters are grouped by category, and the visit is indicated in
the rows: `PARCAT1`, `PARCAT2` and `AVISIT` are specified in `rowVar`. The
treatment is reported in the column: `TRTP` specified in `colVar`.

Because the laboratory measurement reported as normal or empty ('') in the ADaM
are not of interest, these classes are filtered via the `varIgnore` parameter.

By default, the number ('N') and percentage ('Perc') are reported for each
`rowVar`/`colVar`.

```{r example-countTable-LB}

	dataLB <- subset(dataAll$ADLB, AN01FL == "Y")
	
	# ensure that order of elements is the one specified in the corresponding numeric variable
	library(glpgUtilityFct)
	dataLB[dataLB[, "PARCAT2"] == "", "PARCAT2"] <- "OTHER"
	dataLB <- convertVarToFactor(
		data = dataLB, 
		var = c("PARCAT1", "PARCAT2", "AVISIT", "TRTP", "ANRIND"), 
		varNum = c("PARCAT1N", "PARCAT2N", "AVISITN", "TRTPN", "ANRINDN")
	)
	
	# only consider abnormalities
	dataLB <- subset(dataLB, !ANRIND %in% c("", "L"))
	
	# specific analysis visits
	dataLB <- subset(dataLB, AVISIT %in% c("Baseline", "Day 14", "Day 28", "Follow-up"))
	
	# create summary table
	getSummaryStatisticsTable(
		data = dataLB,
		rowVar = c("PARCAT1", "PARCAT2", "PARAMCD", "ANRIND"),
		rowVarInSepCol = "ANRIND",
		colVar = c("TRTP", "AVISIT"),  
		type = "count",
		labelVars = labelVars,
		rowPadBase = 10,
		stats = list(expression(paste0(statN, " (", round(statPercN, 1), ")"))),
		title = "Table: Treatment-emergent laboratory abnormalities",
		file = "summaryStatisticsTable_LB_count.docx",
		footer = "Statistics: N (%)",
		landscape = TRUE
	)

```

## Adverse events

```{r example-countTable-AE}

	dataAE <-  subset(dataAll$ADAE, FASFL == "Y")
	
	# ensure that order of elements is the one specified in the corresponding numeric variable
	library(glpgUtilityFct)
	dataAE <- convertVarToFactor(
		data = dataAE, 
		var = "TRTP", 
		varNum = "TRTPN"
	)

	# dataset used to extract the 'Total'
	dataTotal <- dataAll$ADSL
	# should contain columns specified in 'colVar'
	dataTotal$TRTP <- dataTotal$TRT01P 
	
	getSummaryStatisticsTable(
		data = dataAE,
		type = "count",
		rowVar = c("AEHLGT", "AEHLT", "AELLT"),
		colVar = "TRTP",
		labelVars = labelVars,
		rowPadBase = 10,
		title = "Table: Adverse Events",
		dataTotal = dataTotal,
		rowTotalInclude = TRUE,
		stats = list(expression(paste0(statN, " (", round(statPercN, 1), ")"))),
		footer = "Statistics: N (%)",
		file = "summaryStatisticsTable_AE_count.docx",
	)

```

## Pharmacokinetic parameters

```{r example-PP}
	
	dataPP <- dataAll$ADPP
	
	# ensure that order of elements is the one specified in the corresponding numeric variable
	library(glpgUtilityFct)
	dataPP <- convertVarToFactor(
		data = dataPP, 
		var = c("PARCAT1", "PARAM", "AVISIT", "TRTP"), 
		varNum = c("PARCAT1N", "PARAMN", "AVISITN", "TRTPN")
	)
	
	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = c("TRTP", "AVISIT"),
		rowVar = c("PARCAT1", "PARAM"),
		labelVars = labelVars,
		stats =  list(expression(paste0(formatC(statMedian), "\n(", 
			formatC(statMin), ", ", formatC(statMin), ")"))),
		footer = "Statistics: median (min, max)",
		file = "summaryStatisticsTable_PP_summaryStatistics.docx"
	)

```

## Mock-up tables

```{r mockUpTables}

	# create summary table
	getSummaryStatisticsTable(
		data = dataLB,
		rowVar = c("PARCAT1", "PARCAT2", "PARAMCD", "ANRIND"),
		rowVarInSepCol = "ANRIND",
		colVar = c("TRTP", "AVISIT"),  
		type = "count",
		labelVars = labelVars,
		rowPadBase = 10,
		stats = list(expression(paste0("[X.XX]"))),
		title = "Table: Treatment-emergent laboratory abnormalities (mock-up)",
		file = "summaryStatisticsTable_LB_mockUp_count.docx",
		footer = "Statistics: N (%)",
		landscape = TRUE
	)

```


# Visualization

Summary statistics can be visualized via **error bars** by:

* extracting the summary statistics table with the
  `computeSummaryStatisticsTable` function (used for `getSummaryStatistics` function)
* visualizing the summary statistics via the `subjectProfileSummaryPlot`
  function

```{r visualization, out.width = "100%", fig.height = 6, fig.width = 9}

	summaryTableDf <- computeSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		rowVar = "PARAM",
		colVar = c("TRTP", "AVISIT")
	)

	# create the plot
	subjectProfileSummaryPlot(
		data = subset(summaryTableDf, !isTotal),
		xVar = "AVISIT",
		colorVar = "TRTP",
		labelVars = labelVars,
		facetVar = "PARAM",
		useLinetype = TRUE
	)

```

# Format details

The `getSummaryStatisticsTable` function **returns a `flextable` object
(see `?flextable`)**.

When printed into the R console, this object is displayed in the browser.
This object can be inserted within a rmarkdown document by printing it in the
specified document chunk.

This can also be exported to a _docx_ file, in case the `file` parameter is
specified.

# Appendix

## Session information

```{r includeSessionInfo, echo = FALSE}

	pander(sessionInfo())

```
