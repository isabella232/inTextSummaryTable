---
title: "Vignette of the `inTextSummaryTable` package"
author: "Laure Cougnaud"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float:
      collapsed: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{inTextSummaryTable package}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# Introduction

```{r options, echo = FALSE}
	
	library(knitr)
	opts_chunk$set(
		echo = TRUE, results = 'asis', warning = FALSE, 
		error = FALSE, message = FALSE, cache = FALSE,
		fig.width = 8, fig.height = 7,
		fig.path = "./figures_vignette/",
		#out.width = '0.7\\textwidth', 
		fig.align = 'center')#, out.height = 0.5\\textwidth', fig.path = 'graphs/') 
	options(width = 170)#, stringsAsFactors = FALSE
	options(warn = 1)#instead of warn = 0 by default -> to have place where warnings occur in the call to Sweave function
	
```

This package `patientProfilesVis` enables to create report containing subject
profiles.

```{r loadPackages}

	library(inTextSummaryTable)
	library(pander)

```

## Data format

The input dataset for the workflow should be a data.frame, 
usually loaded from a _SAS_ data file (`sas7bdat` format).
The label of the variables stored in the `SAS` datasets is also used
for title/captions. 

The function `loadDataADaMSDTM` from the `patientProfilesVis` package can be
used to load your custom `SAS` dataset(s) of interest.
In this example, the example dataset stored in the `patientProfilesVis`
package is used.

```{r loadData}	
	
#	data(ADaMDataPelican)
#	data(labelVarsADaMPelican)

	# load data
	library(glpgUtilityFct)
	dataFiles <- list.files(
		path = "data/Pelican/ADAM",
		pattern = "*.sas7bdat",
		full.names = TRUE
	)
	dataAll <- loadDataADaMSDTM(files = dataFiles)
	labelVars <- attributes(dataAll)$labelVars

```

# Summary table

The main function is `getSummaryStatisticsTable`, which creates a in-text table
of summary statistics for variable of interest and for specific
grouping variable (`rowVar` and `colVar` for row/column variable(s)).
By default, the summarized variable, specified via the
`var` parameter is the `r labelVars["AVAL"]` (`AVAL` variable).

## Summary statistics

Please find an example of the summary statistics of the _Pharmacokinetics_
parameter (`ADPP` dataset).
By default, a set of summary statistical metrics are computed, see
`? computeSummaryStatistics` for the list of metrics.

```{r summaryTable-PP-general}

	dataPP <- dataAll$ADPP
	
	# ensure that order of elements is the one specified in the corresponding numeric variable
	library(glpgUtilityFct)
	dataPP <- convertVarToFactor(
		data = dataPP, 
		var = c("PARCAT1", "PARAM", "AVISIT", "TRTP"), 
		varNum = c("PARCAT1N", "PARAMN", "AVISITN", "TRTPN")
	)

	# extract all summary statistics
	summaryTablePP <- getSummaryStatisticsTable(
		data = dataPP,
		rowVar = c("PARCAT1", "PARAM"),
		colVar = c("TRTP", "AVISIT"),
		labelVars = labelVars,
		rowPadBase = 10,
		title = "Table: Descriptive statistics pharmacometrics",
		file = "summaryStatisticsTable_PP_allStatistics.docx"
	)
	summaryTablePP
	
```

A custom format of summary statistics can be specified via the `stats`
parameter.
The summary table is restricted to the mean+-SE statistics.

```{r summaryTable-PP-meanSE}
	
	summaryTablePPMeanSE <- getSummaryStatisticsTable(
		data = dataPP,
		rowVar = c("PARCAT1", "PARAM"),
		colVar = c("TRTP", "AVISIT"),
		labelVars = labelVars,
		rowPadBase = 10,
		title = "Table: Descriptive statistics pharmacokinetics",
		file = "summaryStatisticsTable_PP_meanSE.docx",
		footer = "Statistics: mean +- SE",
		stats = list(expression(paste(formatC(Mean), "+-", formatC(SE))))
	)
	summaryTablePPMeanSE

```

The same table is created with the median (minimum, maximum) variable.

```{r summaryTable-PP-medianMinMax}
	
	summaryTablePPMedianMinMax <- getSummaryStatisticsTable(
		data = dataPP,
		rowVar = c("PARCAT1", "PARAM"),
		colVar = c("TRTP", "AVISIT"),
		labelVars = labelVars,
		rowPadBase = 10,
		title = "Table: Descriptive statistics pharmacokinetics",
		footer = "Statistics: median (min, max)",
		file = "summaryStatisticsTable_PP_medianMinMax.docx",
		stats = list(expression(paste0(formatC(Median), " (", formatC(Min), ", ", formatC(Min), ")")))
	)
	summaryTablePPMedianMinMax

```


## Count table

If the specified variable of interest is `var` is not numeric (`character` or
`factor`), a count table is produced.

The number of patients presenting an abnormal laboratory measurement is
reported in the table below.

## General

The laboratory parameters are grouped by category (`PARCAT1` and
`PARCAT2` specified in `rowVar`).
The counts are computed by visit, and treatment.

Because the laboratory measurement reported as normal or empty ('') in the ADaM
are not of interest, these classes are filtered via the `varIgnore` parameter.

```{r countTable-LB}

	dataLB <- subset(dataAll$ADLB, AN01FL == "Y")
	
	# ensure that order of elements is the one specified in the corresponding numeric variable
	library(glpgUtilityFct)
	dataLB <- convertVarToFactor(
		data = dataLB, 
		var = c("PARCAT1", "PARCAT2", "AVISIT", "TRTP", "ANRIND"), 
		varNum = c("PARCAT1N", "PARCAT2N", "AVISITN", "TRTPN", "ANRINDN")
	)
	
	# create summary table
	summaryTableLBNPerc <- getSummaryStatisticsTable(
		data = dataLB,
		rowVar = c("PARCAT1", "PARCAT2", "PARAM", "AVISIT"),
		rowVarInSepCol = "AVISIT",
		colVar = "TRTP",
		var = "ANRIND", varIgnore = c("", "N"),
		labelVars = labelVars,
		rowPadBase = 10,
		title = "Table: Treatment-emergent laboratory abnormalities",
		stats = list(expression(paste0(N, " (", round(Perc), ")"))),
		footer = "Statistics: N (%)",
		file = "summaryStatisticsTable_LB_NWithPerc.docx",
	)
	summaryTableLBNPerc

```

## Total count

By default, the total per column is extracted from the number of subjects
available in the data used for the count table. If the total should be extracted
from a different dataset, e.g. if only a subset of the patients are present 
in the data, it should be specified via the `dataTotal` variable.

If not all patients are present in the data in hand, the `dataTotal` parameter
is used to specify a different dataset to extract the total count (used 
for the computation of the percentage).

```{r countTable-LB-customDenominator}

	# dataset used to extract the 'Total'
	dataTotal <- dataAll$ADSL
	# should contain columns specified in 'colVar'
	dataTotal$TRTP <- dataTotal$TRT01P 

	# create summary table
	summaryTableALT <- getSummaryStatisticsTable(
		data = subset(dataLB, PARAMCD == "ALT"),
		rowVar = c("PARCAT1", "PARCAT2", "PARAM", "AVISIT"),
		rowVarInSepCol = "AVISIT",
		colVar = "TRTP",
		var = "ANRIND", varIgnore = c("", "N"),
		labelVars = labelVars,
		rowPadBase = 10,
		title = "Table: Treatment-emergent ALT abnormalities",
		stats = list(expression(paste0(N, " (", round(Perc), ")"))),
		dataTotal = dataTotal,
		footer = "Statistics: N (%)",
		file = "summaryStatisticsTable_LB_NWithPerc_ALT_customTotal.docx",
	)
	summaryTableALT

```

# Visualization

Summary statistics can be visualized via error bars by:

* extracting the summary statistics table with the
  `computeSummaryStatistics` function (used for `getSummaryStatistics` function)
* visualizing the summary statistics via the `subjectProfileSummaryPlot`
  function

```{r visualization, out.width = "100%"}

	summaryTableDf <- computeSummaryStatistics(
		data = dataPP,
		rowVar = "PARAM",
		colVar = c("TRTP", "AVISIT")
	)

	# create the plot
	gg <- subjectProfileSummaryPlot(
		data = summaryTableDf,
		xVar = "AVISIT",
		colorVar = "TRTP",
		labelVars = labelVars,
		facetVar = "PARAM"
	)

```

# Appendix

## Session information


```{r includeSessionInfo, echo = FALSE}

	pander(sessionInfo())

```
