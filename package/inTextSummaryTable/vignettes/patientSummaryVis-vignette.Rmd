---
title: "Vignette of the `inTextSummaryTable` package"
author: "Laure Cougnaud"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: 
  rmarkdown::html_document:
    toc: true
    toc_float:
      collapsed: true
    number_sections: true
vignette: >
  %\VignetteIndexEntry{inTextSummaryTable package}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

# Introduction

```{r options, echo = FALSE}
	
	library(knitr)
	opts_chunk$set(
		echo = TRUE, results = 'asis', warning = FALSE, 
		error = FALSE, message = FALSE, cache = FALSE,
		fig.width = 8, fig.height = 7,
		fig.path = "./figures_vignette/",
		#out.width = '0.7\\textwidth', 
		fig.align = 'center')#, out.height = 0.5\\textwidth', fig.path = 'graphs/') 
	options(width = 170)#, stringsAsFactors = FALSE
	options(warn = 1)#instead of warn = 0 by default -> to have place where warnings occur in the call to Sweave function
	
```

The package `inTextSummaryTable` contains functionalities to table of
summary statistics or count table or metrics of interest, to format them as
in-text table, and to export them to a`docx` document.

```{r loadPackages}

	library(pander)
	library(inTextSummaryTable)

```

## Data format

The input data for the creation of summary table should be a data.frame,
usually loaded from _SAS_ data file (`sas7bdat` format).
The label of the variables stored in the `SAS` datasets is also used
for the title/captions. 

Example datasets from the _Pelican_ study included in the
`inTextSummaryTable` package itself are used in this vignette.  

Note that the `loadDataADaMSDTM` function of the `glpgUtilityFct` package can
be used to your custom `SAS` dataset(s) of interest.

```{r loadData}	
	
	# load example data
	data(ADaMDataPelicanInText)
	data(labelVarsADaMPelicanInText)
	
	dataAll <- ADaMDataPelicanInText
	labelVars <- labelVarsADaMPelicanInText

```

# Summary table

The main function is `getSummaryStatisticsTable` which creates a in-text table
of summary statistics for variable(s) of interest.

## Summary statistics

### General

The _Pharmacokinetics_ data (`ADPP` dataset) is used as example for the summary
statistics table.

```{r summaryTable-PP-data}

	dataPP <- dataAll$ADPP
	
	# ensure that order of elements is the one specified in the corresponding numeric variable
	library(glpgUtilityFct)
	dataPP <- convertVarToFactor(
		data = dataPP, 
		var = c("PARCAT1", "PARAM", "AVISIT", "TRTP"), 
		varNum = c("PARCAT1N", "PARAMN", "AVISITN", "TRTPN")
	)

```

The variable to summarize is specified via the `var`
parameter. For the summary statistics table, this variable should be numeric.
By default, an
entire set of summary statistical metrics are computed, see
`? computeSummaryStatisticsTable` for the list of metrics.

```{r summaryTable-PP-simple}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL"
	)

```

### Row variable(s)

Specific grouping variable(s) for the rows can be specified via the
`rowVar` parameter.

For example, the summary statistics are computed for each `r labelVars["PARAM"]`
(`PARAM` parameter).

```{r summaryTable-PP-rowVar}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		rowVar = "PARAM"
	)
	
```

Grouping for the rows can be specified via multiple variables to the `rowVar`
parameter, which should be sorted in hierarchical order.

The `rowPadBase` parameter can be used to change the padding between each row
level.

```{r summaryTable-PP-rowVarMultiple}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		rowVar = c("PARCAT1", "PARAM"),
		rowPadBase = 10
	)
	
```

### Column variable(s)

Similarly, column(s) of interest are specified via the `colVar` parameter.
The total is included for each column.

```{r summaryTable-PP-colVar}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = "TRTP"
	)
	
```

```{r summaryTable-PP-colVarMultiple}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = c("TRTP", "AVISIT")
	)
	
```

### Row and column combinations

```{r summaryTable-PP-rowColVar}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = c("TRTP", "AVISIT"),
		rowVar = c("PARCAT1", "PARAM")
	)
	
```

### Variable labels

The labels used for the variable specified via the `rowVar` parameter are
automatically extracted from the labels contained in the _SAS_ dataset, by
specifying the `labelVars` parameter.

```{r summaryTable-PP-rowVarWithLabel-labelVars}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = c("TRTP", "AVISIT"),
		rowVar = c("PARCAT1", "PARAM"),
		labelVars = labelVars
	)
	
```

The label can also be specified directly via the `rowVarLab` parameter.

```{r summaryTable-PP-rowVarWithLabel-rowVarLab}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = c("TRTP", "AVISIT"),
		rowVar = c("PARCAT1", "PARAM"),
		rowVarLab = c('PARAM' = "Pharmacokinetics parameter", 'PARCAT1' = "Compound")
	)
	
```

### Custom statistics

The `stats` parameter is used to specify a custom format for the statistics.
In the case that a unique statistic is specified, the 'Statistic' column
doesn't appear in the table.

For example, the summary table is restricted to the mean+-SE statistics.

```{r summaryTable-PP-meanSE}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = c("TRTP", "AVISIT"),
		rowVar = c("PARCAT1", "PARAM"),
		labelVars = labelVars,
		stats = list(expression(paste(formatC(Mean), "+-", formatC(SE)))),
		footer = "Statistics: mean +- SE",
		rowPadBase = 10
	)

```
The same table is created with the median (minimum, maximum) variable.

```{r summaryTable-PP-medianMinMax}
	
	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = c("TRTP", "AVISIT"),
		rowVar = c("PARCAT1", "PARAM"),
		labelVars = labelVars,
		stats =  list(expression(paste0(formatC(Median), " (", formatC(Min), ", ", formatC(Min), ")"))),
		footer = "Statistics: median (min, max)"
	)

```

### Row as separated columns

Row variables that shouldn't be included as grouping for the rows, but as
separated column are via the `rowVarInSepCol` parameter.

```{r summaryTable-PP-rowVarInSepCol}

	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = c("TRTP", "AVISIT"),
		rowVar = c("PARCAT1", "PARAM"),
		rowVarInSepCol = "PARAM",
		labelVars = labelVars,
		stats =  list(expression(paste0(formatC(Median), " (", formatC(Min), ", ", formatC(Min), ")"))),
		footer = "Statistics: median (min, max)"
	)
	
```

## Count table

Count table are obtained by specifying the `type` parameter to 'countTable'.
In this case, no `var` variable should be specified.

The adverse event dataset is used as an example.

```{r countTable-AE-data}

	dataAE <-  subset(dataAll$ADAE, FASFL == "Y")
	
	# ensure that order of elements is the one specified in the corresponding numeric variable
	library(glpgUtilityFct)
	dataAE <- convertVarToFactor(
		data = dataAE, 
		var = "TRTP", 
		varNum = "TRTPN"
	)

```

### General

By default, a set of custom statistics are computed, see the
`? computeSummaryStatisticsTable` for further details.

```{r countTable-AE-simple}

	getSummaryStatisticsTable(
		data = dataAE,
		type = "count"
	)

```	

### Extra functionalities

All functionalities provided for the summary statistics table are also available
for the count table.  

In the following example: the counts of subjects and records for the adverse
events are reformatted as: 'N/m (%)' with the `stats` parameter, and the adverse
event term are grouped according to the `r labelVars["AEHLGT"]` ('AEHLGT) and
`r labelVars["AEHLT"]` ('AEHLT') variable.

```{r countTable-AE-extra}

	getSummaryStatisticsTable(
		data = dataAE,
		type = "count",
		rowVar = c("AEHLGT", "AEHLT", "AELLT"),
		colVar = "TRTP",
		labelVars = labelVars,
		rowPadBase = 10,
		title = "Table: Adverse Events",
		stats = list(
			'N (%)' = expression(paste0(N, " (", round(PercN, 1), ")")),
			'm (%)' = expression(paste0(m, " (", round(Percm, 1), ")"))
		),
		footer = "Statistics: number and percentage of subjects: N (%) and records: m (%)"
	)

```	

### Denominator dataset for total count per column

By default, the total per column is extracted from the number of subjects
available in the data used for the count table. If the total should be extracted
from a different dataset, e.g. if only a subset of the patients are present 
in the data, it should be specified via the `dataTotal` variable (used also for
the computation of the percentage).

For example, the total number of patients per treatment is extracted from the 
subject-level (`ADSL`) dataset. 

```{r countTable-LB-customDenominator}

	# dataset used to extract the 'Total'
	dataTotal <- dataAll$ADSL
	# should contain columns specified in 'colVar'
	dataTotal$TRTP <- dataTotal$TRT01P 
	
	getSummaryStatisticsTable(
		data = dataAE,
		type = "count",
		rowVar = c("AEHLGT", "AEHLT", "AELLT"),
		colVar = "TRTP",
		labelVars = labelVars,
		rowPadBase = 10,
		title = "Table: Adverse Events",
		dataTotal = dataTotal,
		stats = list(expression(paste0(N, " (", round(PercN, 1), ")"))),
		footer = "Statistics: N (%)"
	)

```

### Total count of events across rows

The `rowTotalInclude` is set to TRUE to obtain the total number of events
across the entire table per column.

```{r countTable-LB-rowTotalInclude}

	# dataset used to extract the 'Total'
	dataTotal <- dataAll$ADSL
	# should contain columns specified in 'colVar'
	dataTotal$TRTP <- dataTotal$TRT01P 
	
	getSummaryStatisticsTable(
		data = dataAE,
		type = "count",
		rowVar = c("AEHLGT", "AEHLT", "AELLT"),
		colVar = "TRTP",
		labelVars = labelVars,
		rowPadBase = 10,
		title = "Table: Adverse Events",
		dataTotal = dataTotal,
		rowTotalInclude = TRUE,
		stats = list(expression(paste0(N, " (", round(PercN, 1), ")"))),
		footer = "Statistics: N (%)"
	)

```

# Examples

## Laboratory abnormalities

The laboratory parameters are grouped by category, and the visit is indicated in
the rows: `PARCAT1`, `PARCAT2` and `AVISIT` are specified in `rowVar`. The
treatment is reported in the column: `TRTP` specified in `colVar`.

Because the laboratory measurement reported as normal or empty ('') in the ADaM
are not of interest, these classes are filtered via the `varIgnore` parameter.

By default, the number ('N') and percentage ('Perc') are reported for each
`rowVar`/`colVar`.

```{r example-countTable-LB}

	dataLB <- subset(dataAll$ADLB, AN01FL == "Y")
	
	# ensure that order of elements is the one specified in the corresponding numeric variable
	library(glpgUtilityFct)
	dataLB <- convertVarToFactor(
		data = dataLB, 
		var = c("PARCAT1", "PARCAT2", "AVISIT", "TRTP", "ANRIND"), 
		varNum = c("PARCAT1N", "PARCAT2N", "AVISITN", "TRTPN", "ANRINDN")
	)
	
	# only consider abnormalities
	dataLB <- subset(dataLB, !ANRIND %in% c("", "L"))
	
	# specific analysis visits
	dataLB <- subset(dataLB, AVISIT %in% c("Baseline", "Day 14", "Day 28", "Follow-up"))
	
	# create summary table
	summaryTableLBCount <- getSummaryStatisticsTable(
		data = dataLB,
		rowVar = c("PARCAT1", "PARCAT2", "PARAMCD", "ANRIND"),
		rowVarInSepCol = "ANRIND",
		colVar = c("TRTP", "AVISIT"),  
		type = "count",
		labelVars = labelVars,
		rowPadBase = 10,
		stats = list(expression(paste0(N, " (", round(PercN, 1), ")"))),
		title = "Table: Treatment-emergent laboratory abnormalities",
		file = "summaryStatisticsTable_LB_count.docx",
		footer = "Statistics: N (%)",
		landscape = TRUE
	)
	summaryTableLBCount

```

### Adverse events

```{r example-countTable-AE}

	dataAE <-  subset(dataAll$ADAE, FASFL == "Y")
	
	# ensure that order of elements is the one specified in the corresponding numeric variable
	library(glpgUtilityFct)
	dataAE <- convertVarToFactor(
		data = dataAE, 
		var = "TRTP", 
		varNum = "TRTPN"
	)

	# dataset used to extract the 'Total'
	dataTotal <- dataAll$ADSL
	# should contain columns specified in 'colVar'
	dataTotal$TRTP <- dataTotal$TRT01P 
	
	getSummaryStatisticsTable(
		data = dataAE,
		type = "count",
		rowVar = c("AEHLGT", "AEHLT", "AELLT"),
		colVar = "TRTP",
		labelVars = labelVars,
		rowPadBase = 10,
		title = "Table: Adverse Events",
		dataTotal = dataTotal,
		rowTotalInclude = TRUE,
		stats = list(expression(paste0(N, " (", round(PercN, 1), ")"))),
		footer = "Statistics: N (%)",
		file = "summaryStatisticsTable_AE_count.docx",
	)

```

## Pharmacokinetic parameters

```{r example-PP}
	
	dataPP <- dataAll$ADPP
	
	# ensure that order of elements is the one specified in the corresponding numeric variable
	library(glpgUtilityFct)
	dataPP <- convertVarToFactor(
		data = dataPP, 
		var = c("PARCAT1", "PARAM", "AVISIT", "TRTP"), 
		varNum = c("PARCAT1N", "PARAMN", "AVISITN", "TRTPN")
	)
	
	getSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		colVar = c("TRTP", "AVISIT"),
		rowVar = c("PARCAT1", "PARAM"),
		labelVars = labelVars,
		stats =  list(expression(paste0(formatC(Median), " (", formatC(Min), ", ", formatC(Min), ")"))),
		footer = "Statistics: median (min, max)",
		file = "summaryStatisticsTable_PP_summaryStatistics.docx"
	)

```


# Visualization

Summary statistics can be visualized via error bars by:

* extracting the summary statistics table with the
  `computeSummaryStatisticsTable` function (used for `getSummaryStatistics` function)
* visualizing the summary statistics via the `subjectProfileSummaryPlot`
  function

```{r visualization, out.width = "100%", fig.height = 6, fig.width = 9}

	summaryTableDf <- computeSummaryStatisticsTable(
		data = dataPP,
		var = "AVAL",
		rowVar = "PARAM",
		colVar = c("TRTP", "AVISIT")
	)

	# create the plot
	subjectProfileSummaryPlot(
		data = subset(summaryTableDf, !isTotal),
		xVar = "AVISIT",
		colorVar = "TRTP",
		labelVars = labelVars,
		facetVar = "PARAM",
		useLinetype = TRUE
	)

```

# Format details

The `getSummaryStatisticsTable` function returns a `flextable` object
(`? flextable`).

When printed into the R console, this object is displayed in the browser.
This object can be inserted within a rmarkdown document by printing in the
specified document chunk.

This can also be exported to a _docx_ format.

# Appendix

## Session information

```{r includeSessionInfo, echo = FALSE}

	pander(sessionInfo())

```
